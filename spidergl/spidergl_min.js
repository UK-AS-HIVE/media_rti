/*************************************************************************/
/*                                                                       */
/*  SpiderGL                                                             */
/*  JavaScript 3D Graphics Library on top of WebGL                       */
/*                                                                       */
/*  Copyright (C) 2010                                                   */
/*  Marco Di Benedetto                                                   */
/*  Visual Computing Laboratory                                          */
/*  ISTI - Italian National Research Council (CNR)                       */
/*  http://vcg.isti.cnr.it                                               */
/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */
/*                                                                       */
/*  This file is part of SpiderGL.                                       */
/*                                                                       */
/*  SpiderGL is free software; you can redistribute it and/or modify     */
/*  under the terms of the GNU Lesser General Public License as          */
/*  published by the Free Software Foundation; either version 2.1 of     */
/*  the License, or (at your option) any later version.                  */
/*                                                                       */
/*  SpiderGL is distributed in the hope that it will be useful, but      */
/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */
/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */
/*  See the GNU Lesser General Public License                            */
/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */
/*                                                                       */
/*************************************************************************/

function sglUnknown(){throw new Error("SpiderGL : UNKNOWN")}function sglUnsupported(){throw new Error("SpiderGL : UNSUPPORTED")}function sglUnimplemented(){throw new Error("SpiderGL : UNIMPLEMENTED")}function sglInvalidParameter(){throw new Error("SpiderGL : INVALID_PARAMETER")}function sglInvalidCall(){throw new Error("SpiderGL : INVALID_CALL")}function sglDefineConstant(e,t,n){e[t]=n}function sglInherit(e,t){e.prototype=new t;e.prototype.constructor=e}function sglInitialize(){}function sglFinalize(){}function sglNodeText(e){var t=document.getElementById(e);if(!t)return null;var n="";var r=t.firstChild;while(r){if(r.nodeType==3){n+=r.textContent}r=r.nextSibling}return n}function sglLoadFile(e,t){var n=t?true:false;var r=new XMLHttpRequest;if(n){r.onreadystatechange=function(){if(r.readyState==4){if(t){t(r.responseText)}}}}r.open("GET",e,n);r.send(null);var i=null;if(!n){i=r.responseText}return i}function sglGetLines(e){var t=e.split("\n");var n=t.length;var r=[];var i=null;for(var s=0;s<n;++s){i=t[s].replace(/[ \t]+/g," ").replace(/\s\s*$/,"");if(i.length>0){r.push(i)}}return r}function SglRequest(e){this._priority=null;this._status=SGL_REQUEST_IDLE;this._queue=null;this._onReady=[];if(e){this.addOnReadyCallback(e)}}function SglTextFileRequest(e,t){SglRequest.apply(this,Array.prototype.slice.call(arguments,1));this._url=e;this._req=null;Object.defineProperty(this,"url",{get:function(){return this._url}});Object.defineProperty(this,"text",{get:function(){return this._req.responseText}})}function SglImageRequest(e,t){SglRequest.apply(this,Array.prototype.slice.call(arguments,1));this._url=e;this._img=null;Object.defineProperty(this,"url",{get:function(){return this._url}});Object.defineProperty(this,"image",{get:function(){return this._img}})}function SglRequestWatcher(e,t){var n=e.length;this._onReady=t?t:null;this._waitingReqs=n;this._succeededReqs=0;this._failedReqs=0;this._reqs=e.slice();var r=this;var i=function(e){if(e.succeeded){r._succeededReqs++}else if(e.failed){r._failedReqs++}r._waitingReqs--;if(r.isReady){if(r._onReady){r._onReady(r)}}};for(var s=0;s<n;++s){if(e[s].succeeded){this._succeededReqs++;this._waitingReqs--}else if(e[s].failed){this._failedReqs++;this._waitingReqs--}else{e[s].addOnReadyCallback(i)}}if(this._waitingReqs<=0){if(this._onReady){this._onReady(this)}}}function SglRequestQueue(e,t,n){this._maxOngoing=e>0?e:0;this._maxQueued=t>0?t:0;this._ongoing=[];this._queued=[];this._onReady=null;this._minPriorityReq=null;this._priorityCompare=null;this._dirty=true}function sglAbs(e){return Math.abs(e)}function sglFloor(e){return Math.floor(e)}function sglCeil(e){return Math.ceil(e)}function sglSqrt(e){return Math.sqrt(e)}function sglPow(e,t){return Math.pow(e,t)}function sglLog(e){return Math.log(e)}function sglExp(e){return Math.exp(e)}function sglSin(e){return Math.sin(e)}function sglAsin(e){return Math.asin(e)}function sglCos(e){return Math.cos(e)}function sglAcos(e){return Math.acos(e)}function sglTan(e){return Math.tan(e)}function sglAtan(e){return Math.atan(e)}function sglAtan2(e,t){return Math.atan2(e,t)}function sglDegToRad(e){return e*(SGL_PI/180)}function sglRadToDeg(e){return e*(180/SGL_PI)}function sglMin(e,t){return Math.min(e,t)}function sglMax(e,t){return Math.max(e,t)}function sglClamp(e,t,n){return e<=t?t:e>=n?n:e}function sglRandom01(){return Math.random()}function sglMapVN(e,t,r,i,s,o,u){s=s!=undefined?s:0;u=u!=undefined?u:t;o=o!=undefined?o:(e.length-s)/u;var a=s+o*u;var f=new Array(n);var l=0;var c=0;for(var h=s;h<a;h+=u){for(c=0;c<n;++c){f[c]=e[h+c]}r(f,i,l++);for(c=0;c<n;++c){e[h+c]=f[c]}}}function sglMapV2(e,t,n,r,i,s){sglMapVN(e,2,t,n,r,i,s)}function sglMapV3(e,t,n,r,i,s){sglMapVN(e,3,t,n,r,i,s)}function sglMapV4(e,t,n,r,i,s){sglMapVN(e,4,t,n,r,i,s)}function sglUndefV2(e){return new Array(2)}function sglV2V(e){return e.slice(0,2)}function sglV2S(e){return[e,e]}function sglV2C(e,t){return[e,t]}function sglZeroV2(){return sglV2S(0)}function sglOneV2(){return sglV2S(1)}function sglV2(){var e=arguments.length;var t;switch(e){case 1:if(arguments[0]instanceof Array){return sglV2V(arguments[0])}return sglV2S(arguments[0]);break;case 2:return sglV2V(arguments);break;default:return sglZeroV2();break}return null}function sglDupV2(e){return e.slice(0,2)}function sglNegV2(e){return sglV2C(-e[0],-e[1])}function sglAddV2(e,t){return sglV2C(e[0]+t[0],e[1]+t[1])}function sglAddV2S(e,t){return sglV2C(e[0]+t,e[1]+t)}function sglAddSV2(e,t){return sglAddV2S(t,e)}function sglSubV2(e,t){return sglV2C(e[0]-t[0],e[1]-t[1])}function sglSubV2S(e,t){return sglV2C(e[0]-t,e[1]-t)}function sglSubSV2(e,t){return sglV2C(t-e[0],t-e[1])}function sglMulV2(e,t){return sglV2C(e[0]*t[0],e[1]*t[1])}function sglMulV2S(e,t){return sglV2C(e[0]*t,e[1]*t)}function sglMulSV2(e,t){return sglMulV2S(t,e)}function sglDivV2(e,t){return sglV2C(e[0]/t[0],e[1]/t[1])}function sglDivV2S(e,t){return sglV2C(e[0]/t,e[1]/t)}function sglDivSV2(e,t){return sglV2C(e/t[0],e/t[1])}function sglRcpV2(e){return sglDivSV2(1,e)}function sglDotV2(e,t){return e[0]*t[0]+e[1]*t[1]}function sglCrossV2(e,t){return e[0]*t[1]-e[1]*t[0]}function sglSqLengthV2(e){return sglDotV2(e,e)}function sglLengthV2(e){return sglSqrt(sglSqLengthV2(e))}function sglNormalizedV2(e){var t=1/sglLengthV2(e);return sglMulV2S(e,t)}function sglSelfNegV2(e){e[0]=-e[0];e[1]=-e[1];return e}function sglSelfAddV2(e,t){e[0]+=t[0];e[1]+=t[1];return e}function sglSelfAddV2S(e,t){e[0]+=t;e[1]+=t;return e}function sglSelfAddSV2(e,t){t[0]+=e;t[1]+=e;return t}function sglSelfSubV2(e,t){e[0]-=t[0];e[1]-=t[1];return e}function sglSelfSubV2S(e,t){e[0]-=t;e[1]-=t;return e}function sglSelfSubSV2(e,t){e[0]=t-e[0];e[1]=t-e[1];return e}function sglSelfMulV2(e,t){e[0]*=t[0];e[1]*=t[1];return e}function sglSelfMulV2S(e,t){e[0]*=t;e[1]*=t;return e}function sglSelfMulSV2(e,t){t[0]*=e;t[1]*=e;return t}function sglSelfDivV2(e,t){e[0]/=t[0];e[1]/=t[1];return e}function sglSelfDivV2S(e,t){u[0]/=t;u[1]/=t;return u}function sglSelfDivSV2(e,t){t[0]=e/t[0];t[1]=e/t[1];return t}function sglSelfRcpV2(e){return sglSelfDivSV2(1,e)}function sglSelfNormalizeV2(e){var t=1/sglLengthV2(e);return sglSelfMulV2S(e,t)}function sglMinV2(e,t){return[e[0]<t[0]?e[0]:t[0],e[1]<t[1]?e[1]:t[1]]}function sglMaxV2(e,t){return[e[0]>t[0]?e[0]:t[0],e[1]>t[1]?e[1]:t[1]]}function sglV2toV3(e,t){return sglV3C(e[0],e[1],t)}function sglV2toV4(e,t,n){return sglV4C(e[0],e[1],t,n)}function sglUndefV3(e){return new Array(3)}function sglV3V(e){return e.slice(0,3)}function sglV3S(e){return[e,e,e]}function sglV3C(e,t,n){return[e,t,n]}function sglZeroV3(){return sglV3S(0)}function sglOneV3(){return sglV3S(1)}function sglV3(){var e=arguments.length;var t;switch(e){case 1:if(arguments[0]instanceof Array){return sglV3V(arguments[0])}return sglV3S(arguments[0]);break;case 3:return sglV3V(arguments);break;default:return sglZeroV3();break}return null}function sglDupV3(e){return e.slice(0,3)}function sglNegV3(e){return sglV3C(-e[0],-e[1],-e[2])}function sglAddV3(e,t){return sglV3C(e[0]+t[0],e[1]+t[1],e[2]+t[2])}function sglAddV3S(e,t){return sglV3C(e[0]+t,e[1]+t,e[2]+t)}function sglAddSV3(e,t){return sglAddV3S(t,e)}function sglSubV3(e,t){return sglV3C(e[0]-t[0],e[1]-t[1],e[2]-t[2])}function sglSubV3S(e,t){return sglV3C(e[0]-t,e[1]-t,e[2]-t)}function sglSubSV3(e,t){return sglV3C(t-e[0],t-e[1],t-e[2])}function sglMulV3(e,t){return sglV3C(e[0]*t[0],e[1]*t[1],e[2]*t[2])}function sglMulV3S(e,t){return sglV3C(e[0]*t,e[1]*t,e[2]*t)}function sglMulSV3(e,t){return sglMulV3S(t,e)}function sglDivV3(e,t){return sglV3C(e[0]/t[0],e[1]/t[1],e[2]/t[2])}function sglDivV3S(e,t){return sglV3C(e[0]/t,e[1]/t,e[2]/t)}function sglDivSV3(e,t){return sglV3C(e/t[0],e/t[1],e/t[2])}function sglRcpV3(e){return sglDivSV3(1,e)}function sglDotV3(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function sglCrossV3(e,t){return sglV3C(e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0])}function sglSqLengthV3(e){return sglDotV3(e,e)}function sglLengthV3(e){return sglSqrt(sglSqLengthV3(e))}function sglNormalizedV3(e){var t=1/sglLengthV3(e);return sglMulV3S(e,t)}function sglSelfNegV3(e){e[0]=-e[0];e[1]=-e[1];e[2]=-e[2];return e}function sglSelfAddV3(e,t){e[0]+=t[0];e[1]+=t[1];e[2]+=t[2];return e}function sglSelfAddV3S(e,t){e[0]+=t;e[1]+=t;e[2]+=t;return e}function sglSelfAddSV3(e,t){t[0]+=e;t[1]+=e;t[2]+=e;return t}function sglSelfSubV3(e,t){e[0]-=t[0];e[1]-=t[1];e[2]-=t[2];return e}function sglSelfSubV3S(e,t){e[0]-=t;e[1]-=t;e[2]-=t;return e}function sglSelfSubSV3(e,t){e[0]=t-e[0];e[1]=t-e[1];e[2]=t-e[2];return e}function sglSelfMulV3(e,t){e[0]*=t[0];e[1]*=t[1];e[2]*=t[2];return e}function sglSelfMulV3S(e,t){e[0]*=t;e[1]*=t;e[2]*=t;return e}function sglSelfMulSV3(e,t){t[0]*=e;t[1]*=e;t[2]*=e;return t}function sglSelfDivV3(e,t){e[0]/=t[0];e[1]/=t[1];e[2]/=t[2];return e}function sglSelfDivV3S(e,t){u[0]/=t;u[1]/=t;u[2]/=t;return u}function sglSelfDivSV3(e,t){t[0]=e/t[0];t[1]=e/t[1];t[2]=e/t[2];return t}function sglSelfRcpV3(e){return sglSelfDivSV3(1,e)}function sglSelfCrossV3(e,t){var n=sglV3C(e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]);e[0]=n[0];e[1]=n[1];e[2]=n[2];return e}function sglSelfNormalizeV3(e){var t=1/sglLengthV3(e);return sglSelfMulV3S(e,t)}function sglMinV3(e,t){return[e[0]<t[0]?e[0]:t[0],e[1]<t[1]?e[1]:t[1],e[2]<t[2]?e[2]:t[2]]}function sglMaxV3(e,t){return[e[0]>t[0]?e[0]:t[0],e[1]>t[1]?e[1]:t[1],e[2]>t[2]?e[2]:t[2]]}function sglV3toV2(e){return e.slice(0,2)}function sglV3toV4(e,t){return sglV4C(e[0],e[1],e[2],t)}function sglUndefV4(e){return new Array(4)}function sglV4V(e){return e.slice(0,4)}function sglV4S(e){return[e,e,e,e]}function sglV4C(e,t,n,r){return[e,t,n,r]}function sglZeroV4(){return sglV4S(0)}function sglOneV4(){return sglV4S(1)}function sglV4(){var e=arguments.length;var t;switch(e){case 1:if(arguments[0]instanceof Array){return sglV4V(arguments[0])}return sglV4S(arguments[0]);break;case 4:return sglV4V(arguments);break;default:return sglZeroV4();break}return null}function sglDupV4(e){return e.slice(0,4)}function sglNegV4(e){return sglV4C(-e[0],-e[1],-e[2],-e[3])}function sglAddV4(e,t){return sglV4C(e[0]+t[0],e[1]+t[1],e[2]+t[2],e[3]+t[3])}function sglAddV4S(e,t){return sglV4C(e[0]+t,e[1]+t,e[2]+t,e[3]+t)}function sglAddSV4(e,t){return sglAddV4S(t,e)}function sglSubV4(e,t){return sglV4C(e[0]-t[0],e[1]-t[1],e[2]-t[2],e[3]-t[3])}function sglSubV4S(e,t){return sglV4C(e[0]-t,e[1]-t,e[2]-t,e[3]-t)}function sglSubSV4(e,t){return sglV4C(t-e[0],t-e[1],t-e[2],t-e[3])}function sglMulV4(e,t){return sglV4C(e[0]*t[0],e[1]*t[1],e[2]*t[2],e[3]*t[3])}function sglMulV4S(e,t){return sglV4C(e[0]*t,e[1]*t,e[2]*t,e[3]*t)}function sglMulSV4(e,t){return sglMulV4S(t,e)}function sglDivV4(e,t){return sglV4C(e[0]/t[0],e[1]/t[1],e[2]/t[2],e[3]/t[3])}function sglDivV4S(e,t){return sglV4C(e[0]/t,e[1]/t,e[2]/t,e[3]/t)}function sglDivSV4(e,t){return sglV4C(e/t[0],e/t[1],e/t[2],e/t[3])}function sglRcpV4(e){return sglDivSV4(1,e)}function sglDotV4(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function sglSqLengthV4(e){return sglDotV4(e,e)}function sglLengthV4(e){return sglSqrt(sglSqLengthV4(e))}function sglNormalizedV4(e){var t=1/sglLengthV4(e);return sglMulV4S(e,t)}function sglProjectV4(e){var t=1/e[3];return sglV4C(e[0]*t,e[1]*t,e[2]*t,1)}function sglSelfNegV4(e){e[0]=-e[0];e[1]=-e[1];e[2]=-e[2];e[3]=-e[3];return e}function sglSelfAddV4(e,t){e[0]+=t[0];e[1]+=t[1];e[2]+=t[2];e[3]+=t[3];return e}function sglSelfAddV4S(e,t){e[0]+=t;e[1]+=t;e[2]+=t;e[3]+=t;return e}function sglSelfAddSV4(e,t){t[0]+=e;t[1]+=e;t[2]+=e;t[3]+=e;return t}function sglSelfSubV4(e,t){e[0]-=t[0];e[1]-=t[1];e[2]-=t[2];e[3]-=t[3];return e}function sglSelfSubV4S(e,t){e[0]-=t;e[1]-=t;e[2]-=t;e[3]-=t;return e}function sglSelfSubSV4(e,t){e[0]=t-e[0];e[1]=t-e[1];e[2]=t-e[2];e[3]=t-e[3];return e}function sglSelfMulV4(e,t){e[0]*=t[0];e[1]*=t[1];e[2]*=t[2];e[3]*=t[3];return e}function sglSelfMulV4S(e,t){e[0]*=t;e[1]*=t;e[2]*=t;e[3]*=t;return e}function sglSelfMulSV4(e,t){t[0]*=e;t[1]*=e;t[2]*=e;t[3]*=e;return t}function sglSelfDivV4(e,t){e[0]/=t[0];e[1]/=t[1];e[2]/=t[2];e[3]/=t[3];return e}function sglSelfDivV4S(e,t){u[0]/=t;u[1]/=t;u[2]/=t;u[3]/=t;return u}function sglSelfDivSV4(e,t){t[0]=e/t[0];t[1]=e/t[1];t[2]=e/t[2];t[3]=e/t[3];return t}function sglSelfRcpV4(e){return sglSelfDivSV4(1,e)}function sglSelfNormalizeV4(e){var t=1/sglLengthV4(e);return sglSelfMulV4S(e,t)}function sglSelfProjectV4(e){var t=1/e[3];e[0]*=t;e[1]*=t;e[2]*=t;e[3]=1;return e}function sglMinV4(e,t){return[e[0]<t[0]?e[0]:t[0],e[1]<t[1]?e[1]:t[1],e[2]<t[2]?e[2]:t[2],e[3]<t[3]?e[3]:t[3]]}function sglMaxV4(e,t){return[e[0]>t[0]?e[0]:t[0],e[1]>t[1]?e[1]:t[1],e[2]>t[2]?e[2]:t[2],e[3]>t[3]?e[3]:t[3]]}function sglV4toV2(e){return e.slice(0,2)}function sglV4toV3(e){return e.slice(0,3)}function sglUndefM4(){return new Array(16)}function sglM4V(e){return e.slice(0,16)}function sglM4S(e){var t=sglUndefM4();for(var n=0;n<16;++n){t[n]=e}return t}function sglDiagM4V(e){var t=sglM4S(0);t[0]=e[0];t[5]=e[1];t[10]=e[2];t[15]=e[3];return t}function sglDiagM4S(e){var t=sglM4S(0);t[0]=e;t[5]=e;t[10]=e;t[15]=e;return t}function sglDiagM4C(e,t,n,r){return sglDiagM4V(arguments)}function sglZeroM4(){return sglM4S(0)}function sglOneM4(){return sglM4S(1)}function sglIdentityM4(){return sglDiagM4S(1)}function sglM4(){var e=arguments.length;switch(e){case 1:if(arguments[0]instanceof Array){switch(arguments[0].length){case 1:return sglDiagM4S(arguments[0]);break;case 4:return sglDiagM4V(arguments[0]);break;case 16:return sglM4V(arguments[0]);break;default:return sglIdentityM4();break}}return sglM4S(arguments[0]);break;case 4:return sglDiagM4V(arguments);break;case 16:return sglM4V(arguments);break;default:return sglIdentityM4();break}return null}function sglDupM4(e){var t=sglUndefM4();t[0]=e[0];t[1]=e[1];t[2]=e[2];t[3]=e[3];t[4]=e[4];t[5]=e[5];t[6]=e[6];t[7]=e[7];t[8]=e[8];t[9]=e[9];t[10]=e[10];t[11]=e[11];t[12]=e[12];t[13]=e[13];t[14]=e[14];t[15]=e[15];return t}function sglGetElemM4(e,t,n){return e[t+n*4]}function sglSetElemM4(e,t,n,r){e[t+n*4]=r}function sglGetRowM4(e,t){return sglV4C(e[t+0],e[t+4],e[t+8],e[t+12])}function sglSetRowM4V(e,t,n){e[t+0]=n[0];e[t+4]=n[1];e[t+8]=n[2];e[t+12]=n[3]}function sglSetRowM4S(e,t,n){e[t+0]=n;e[t+4]=n;e[t+8]=n;e[t+12]=n}function sglSetRowM4C(e,t,n,r,i,s){e[t+0]=n;e[t+4]=r;e[t+8]=i;e[t+12]=s}function sglGetColM4(e,t){var n=t*4;return sglV4C(e[n+0],e[n+1],e[n+2],e[n+3])}function sglSetColM4V(e,t,n){var r=t*4;e[r+0]=n[0];e[r+1]=n[1];e[r+2]=n[2];e[r+3]=n[3]}function sglSetColM4S(e,t,n){var r=t*4;e[r+0]=n;e[r+1]=n;e[r+2]=n;e[r+3]=n}function sglSetColM4C(e,t,n,r,i,s){var o=t*4;e[o+0]=n;e[o+1]=r;e[o+2]=i;e[o+3]=s}function sglM4toM3(e){return[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]]}function sglIsIdentityM4(e){var t=0;var n=0;var r=0;for(t=0;t<4;++t){for(n=0;n<4;++n){r=e[t+n*4];if(t==n){if(r!=1){return false}}else{if(r!=0){return false}}}}return true}function sglNegM4(e){var t=sglUndefM4();for(var n=0;n<16;++n){t[n]=-e[n]}return t}function sglAddM4(e,t){var n=sglUndefM4();for(var r=0;r<16;++r){n[r]=e[r]+t[r]}return n}function sglAddM4S(e,t){var n=sglUndefM4();for(var r=0;r<16;++r){n[r]=e[r]+t}return n}function sglAddSM4(e,t){return sglAddM4S(t,e)}function sglSubM4(e,t){var n=sglUndefM4();for(var r=0;r<16;++r){n[r]=e[r]-t[r]}return n}function sglSubM4S(e,t){var n=sglUndefM4();for(var r=0;r<16;++r){n[r]=e[r]-t}return n}function sglSubSM4(e,t){var n=sglUndefM4();for(var r=0;r<16;++r){n[r]=e-t[r]}return n}function sglMulM4(e,t){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],u=e[5],a=e[6],f=e[7],l=e[8],c=e[9],h=e[10],p=e[11],d=e[12],v=e[13],m=e[14],g=e[15],y=t[0],b=t[1],w=t[2],E=t[3],S=t[4],x=t[5],T=t[6],N=t[7],C=t[8],k=t[9],L=t[10],A=t[11],O=t[12],M=t[13],_=t[14],D=t[15];var P=sglUndefM4();P[0]=n*y+o*b+l*w+d*E;P[1]=r*y+u*b+c*w+v*E;P[2]=i*y+a*b+h*w+m*E;P[3]=s*y+f*b+p*w+g*E;P[4]=n*S+o*x+l*T+d*N;P[5]=r*S+u*x+c*T+v*N;P[6]=i*S+a*x+h*T+m*N;P[7]=s*S+f*x+p*T+g*N;P[8]=n*C+o*k+l*L+d*A;P[9]=r*C+u*k+c*L+v*A;P[10]=i*C+a*k+h*L+m*A;P[11]=s*C+f*k+p*L+g*A;P[12]=n*O+o*M+l*_+d*D;P[13]=r*O+u*M+c*_+v*D;P[14]=i*O+a*M+h*_+m*D;P[15]=s*O+f*M+p*_+g*D;return P}function sglMulM4S(e,t){var n=sglUndefM4();for(var r=0;r<16;++r){n[r]=e[r]*t}return n}function sglMulSM4(e,t){return sglMulM4S(t,e)}function sglMulM4V3(e,t,n){return[e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*n,e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*n,e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*n]}function sglMulM4V4(e,t){return[e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3]]}function sglDivM4S(e,t){var n=sglUndefM4();for(var r=0;r<16;++r){n[r]=e[r]/t}return n}function sglDivSM4(e,t){var n=sglUndefM4();for(var r=0;r<16;++r){n[r]=e/t[r]}return n}function sglRcpM4(e){return sglDivSM4(1,e)}function sglCompMulM4(e,t){var n=sglUndefM4();for(var r=0;r<16;++r){n[r]=e[r]*t[r]}return n}function sglCompDivM4(e,t){var n=sglUndefM4();for(var r=0;r<16;++r){n[r]=e[r]/t[r]}return n}function sglTransposeM4(e){var t=sglUndefM4();t[0]=e[0];t[1]=e[4];t[2]=e[8];t[3]=e[12];t[4]=e[1];t[5]=e[5];t[6]=e[9];t[7]=e[13];t[8]=e[2];t[9]=e[6];t[10]=e[10];t[11]=e[14];t[12]=e[3];t[13]=e[7];t[14]=e[11];t[15]=e[15];return t}function sglDeterminantM4(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8],l=e[9],c=e[10],h=e[11],p=e[12],d=e[13],v=e[14],m=e[15];return p*l*u*i-f*d*u*i-p*o*c*i+s*d*c*i+f*o*v*i-s*l*v*i-p*l*r*a+f*d*r*a+p*n*c*a-t*d*c*a-f*n*v*a+t*l*v*a+p*o*r*h-s*d*r*h-p*n*u*h+t*d*u*h+s*n*v*h-t*o*v*h-f*o*r*m+s*l*r*m+f*n*u*m-t*l*u*m-s*n*c*m+t*o*c*m}function sglInverseM4(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8],l=e[9],c=e[10],h=e[11],p=e[12],d=e[13],v=e[14],m=e[15];var g=sglUndefM4();g[0]=l*v*a-d*c*a+d*u*h-o*v*h-l*u*m+o*c*m;g[1]=d*c*i-l*v*i-d*r*h+n*v*h+l*r*m-n*c*m;g[2]=o*v*i-d*u*i+d*r*a-n*v*a-o*r*m+n*u*m;g[3]=l*u*i-o*c*i-l*r*a+n*c*a+o*r*h-n*u*h;g[4]=p*c*a-f*v*a-p*u*h+s*v*h+f*u*m-s*c*m;g[5]=f*v*i-p*c*i+p*r*h-t*v*h-f*r*m+t*c*m;g[6]=p*u*i-s*v*i-p*r*a+t*v*a+s*r*m-t*u*m;g[7]=s*c*i-f*u*i+f*r*a-t*c*a-s*r*h+t*u*h;g[8]=f*d*a-p*l*a+p*o*h-s*d*h-f*o*m+s*l*m;g[9]=p*l*i-f*d*i-p*n*h+t*d*h+f*n*m-t*l*m;g[10]=s*d*i-p*o*i+p*n*a-t*d*a-s*n*m+t*o*m;g[11]=f*o*i-s*l*i-f*n*a+t*l*a+s*n*h-t*o*h;g[12]=p*l*u-f*d*u-p*o*c+s*d*c+f*o*v-s*l*v;g[13]=f*d*r-p*l*r+p*n*c-t*d*c-f*n*v+t*l*v;g[14]=p*o*r-s*d*r-p*n*u+t*d*u+s*n*v-t*o*v;g[15]=s*l*r-f*o*r+f*n*u-t*l*u-s*n*c+t*o*c;var y=1/(p*l*u*i-f*d*u*i-p*o*c*i+s*d*c*i+f*o*v*i-s*l*v*i-p*l*r*a+f*d*r*a+p*n*c*a-t*d*c*a-f*n*v*a+t*l*v*a+p*o*r*h-s*d*r*h-p*n*u*h+t*d*u*h+s*n*v*h-t*o*v*h-f*o*r*m+s*l*r*m+f*n*u*m-t*l*u*m-s*n*c*m+t*o*c*m);for(var b=0;b<16;++b)g[b]*=y;return g}function sglTraceM4(e){return e[0]+e[5]+e[10]+e[15]}function sglTranslationM4V(e){var t=sglIdentityM4();t[12]=e[0];t[13]=e[1];t[14]=e[2];return t}function sglTranslationM4C(e,t,n){return sglTranslationM4V([e,t,n])}function sglTranslationM4S(e){return sglTranslationM4C(e,e,e)}function sglRotationAngleAxisM4V(e,t){var n=sglNormalizedV3(t);var r=sglSin(e);var i=sglCos(e);var s=1-i;var o=n[0];var u=n[1];var a=n[2];var f,l,c,h,p,d,v,m,g;f=o*o;l=u*u;c=a*a;h=o*u;p=u*a;d=a*o;v=o*r;m=u*r;g=a*r;var y=sglUndefM4();y[0]=s*f+i;y[1]=s*h+g;y[2]=s*d-m;y[3]=0;y[4]=s*h-g;y[5]=s*l+i;y[6]=s*p+v;y[7]=0;y[8]=s*d+m;y[9]=s*p-v;y[10]=s*c+i;y[11]=0;y[12]=0;y[13]=0;y[14]=0;y[15]=1;return y}function sglRotationAngleAxisM4C(e,t,n,r){return sglRotationAngleAxisM4V(e,[t,n,r])}function sglScalingM4V(e){var t=sglIdentityM4();t[0]=e[0];t[5]=e[1];t[10]=e[2];return t}function sglScalingM4C(e,t,n){return sglScalingM4V([e,t,n])}function sglScalingM4S(e){return sglScalingM4C(e,e,e)}function sglLookAtM4V(e,t,n){var r=sglNormalizedV3(sglSubV3(t,e));var i=sglNormalizedV3(n);var s=sglNormalizedV3(sglCrossV3(r,i));i=sglNormalizedV3(sglCrossV3(s,r));var o=sglUndefM4();o[0]=s[0];o[1]=i[0];o[2]=-r[0];o[3]=0;o[4]=s[1];o[5]=i[1];o[6]=-r[1];o[7]=0;o[8]=s[2];o[9]=i[2];o[10]=-r[2];o[11]=0;o[12]=0;o[13]=0;o[14]=0;o[15]=1;o=sglMulM4(o,sglTranslationM4V(sglNegV3(e)));return o}function sglLookAtM4C(e,t,n,r,i,s,o,u,a){return sglLookAtM4V([e,t,n],[r,i,s],[o,u,a])}function sglOrthoM4V(e,t){var n=sglAddV3(t,e);var r=sglSubV3(t,e);var i=sglUndefM4();i[0]=2/r[0];i[1]=0;i[2]=0;i[3]=0;i[4]=0;i[5]=2/r[1];i[6]=0;i[7]=0;i[8]=0;i[9]=0;i[10]=-2/r[2];i[11]=0;i[12]=-n[0]/r[0];i[13]=-n[1]/r[1];i[14]=-n[2]/r[2];i[15]=1;return i}function sglOrthoM4C(e,t,n,r,i,s){return sglOrthoM4V([e,n,i],[t,r,s])}function sglFrustumM4V(e,t){var n=sglAddV3(t,e);var r=sglSubV3(t,e);var i=2*e[2];var s=sglUndefM4();s[0]=i/r[0];s[1]=0;s[2]=0;s[3]=0;s[4]=0;s[5]=i/r[1];s[6]=0;s[7]=0;s[8]=n[0]/r[0];s[9]=n[1]/r[1];s[10]=-n[2]/r[2];s[11]=-1;s[12]=0;s[13]=0;s[14]=-i*t[2]/r[2];s[15]=0;return s}function sglFrustumM4C(e,t,n,r,i,s){return sglFrustumM4V([e,n,i],[t,r,s])}function sglPerspectiveM4(e,t,n,r){var i=sglUndefV4();var s=sglUndefV4();i[2]=n;s[2]=r;s[1]=i[2]*sglTan(e/2);i[1]=-s[1];s[0]=s[1]*t;i[0]=-s[0];return sglFrustumM4V(i,s)}function sglUndefQuat(e){return new Array(4)}function sglQuatV(e){return e.slice(0,4)}function sglIdentityQuat(){return[0,0,0,1]}function sglAngleAxisQuat(e,t){var n=e/2;var r=sglSin(n);return[r*t[0],r*t[1],r*t[2],sglCos(n)]}function sglM4Quat(e){var t=sglGetElemM4(e,0,0)+sglGetElemM4(e,1,1)+sglGetElemM4(e,2,2);var n=null;var r=sglUndefQuat();if(t>0){n=sglSqrt(t+1);r[3]=n/2;n=.5/n;r[0]=(sglGetElemM4(e,2,1)-sglGetElemM4(e,1,2))*n;r[1]=(sglGetElemM4(e,0,2)-sglGetElemM4(e,2,0))*n;r[2]=(sglGetElemM4(e,1,0)-sglGetElemM4(e,0,1))*n}else{var i=0;if(sglGetElemM4(e,1,1)>sglGetElemM4(e,0,0))i=1;if(sglGetElemM4(e,2,2)>sglGetElemM4(e,i,i))i=2;var s=(i+1)%3;var o=(s+1)%3;n=sglSqrt(sglGetElemM4(e,i,i)-sglGetElemM4(e,s,s)-sglGetElemM4(e,o,o)+1);r[i]=n/2;n=.5/n;r[3]=(sglGetElemM4(e,o,s)-sglGetElemM4(e,s,o))*n;r[s]=(sglGetElemM4(e,s,i)+sglGetElemM4(e,i,s))*n;r[o]=(sglGetElemM4(e,o,i)+sglGetElemM4(e,i,o))*n}return r}function sglGetQuatAngleAxis(e){var t=new Array(4);var n=sglSqLengthV4(e);var r=null;if(n>0){var i=1/sglSqrt(n);t[0]=e[0]*i;t[1]=e[1]*i;t[2]=e[2]*i;t[3]=2*aglAcos(e[3])}else{t[0]=0;t[1]=0;t[2]=1;t[3]=0}return t}function sglGetQuatRotationM4(e){var t=2*e[0];var n=2*e[1];var r=2*e[2];var i=t*e[3];var s=n*e[3];var o=r*e[3];var u=t*e[0];var a=n*e[0];var f=r*e[0];var l=n*e[1];var c=r*e[1];var h=r*e[2];var p=sglIdentityM4();sglSetElemM4(p,0,0,1-(l+h));sglSetElemM4(p,0,1,a-o);sglSetElemM4(p,0,2,f+s);sglSetElemM4(p,1,0,a+o);sglSetElemM4(p,1,1,1-(u+h));sglSetElemM4(p,1,2,c-i);sglSetElemM4(p,2,0,f-s);sglSetElemM4(p,2,1,c+i);sglSetElemM4(p,2,2,1-(u+l));return p}function sglNormalizedQuat(e){return sglNormalizedV4(e)}function sglMulQuat(e,t){var n=sglUndefQuat();n[0]=p[3]*q[0]+p[0]*q[3]+p[1]*q[2]-p[2]*q[1];n[1]=p[3]*q[1]+p[1]*q[3]+p[2]*q[0]-p[0]*q[2];n[2]=p[3]*q[2]+p[2]*q[3]+p[0]*q[1]-p[1]*q[0];n[3]=p[3]*q[3]-p[0]*q[0]-p[1]*q[1]-p[2]*q[2]}function SglVec2(){this.v=new Array(2);var e=arguments.length;switch(e){case 1:if(arguments[0]instanceof Array){this.setVec(arguments[0])}else if(arguments[0]instanceof SglVec2){this.setVec(arguments[0].v)}else{this.setScalar(arguments[0])}break;case 2:this.setVec(arguments);break;default:this.setZero();break}}function SglVec3(){this.v=new Array(3);var e=arguments.length;switch(e){case 1:if(arguments[0]instanceof Array){this.setVec(arguments[0])}else if(arguments[0]instanceof SglVec3){this.setVec(arguments[0].v)}else{this.setScalar(arguments[0])}break;case 3:this.setVec(arguments);break;default:this.setZero();break}}function SglVec4(){this.v=new Array(4);var e=arguments.length;switch(e){case 1:if(arguments[0]instanceof Array){this.setVec(arguments[0])}else if(arguments[0]instanceof SglVec4){this.setVec(arguments[0].v)}else{this.setScalar(arguments[0])}break;case 4:this.setVec(arguments);break;default:this.setZero();break}}function SglPlane3(e,t,n){this._normal=[0,0,1];this._offset=0;if(e&&t){this.setup(e,t,n)}}function SglBox3(e,t){this._min=[1,1,1];this._max=[-1,-1,-1];if(e&&t){this.setup(e,t)}}function SglSphere3(e,t){this._center=[0,0,0];this._radius=-1;if(e&&t){this.setup(e,t)}}function SglMatrixStack(){this._s=[];this._s.push(sglIdentityM4());this._n=0}function SglTransformStack(){this._ms=new SglMatrixStack;this._vs=new SglMatrixStack;this._ps=new SglMatrixStack}function _SglFrustumPlane(){this.normal=[0,0,1];this.offset=0;this.testVertex=[0,0,0]}function SglFrustum(e,t,n){this._mvpMatrix=sglIdentityM4();this._viewport=[0,0,1,1];this._vp=[0,0,1,1];this._billboardMatrix=sglIdentityM4();this._planes=new Array(6);for(var r=0;r<6;++r){this._planes[r]=new _SglFrustumPlane}if(e&&t&&n){this.setup(e,t,n)}}function sglBoxVisibility(e,t,n){var r=new SglFrustum(e);return r.boxVisibility(t,n)}function _sglConsolidateOptions(e,t){if(t){for(var n in t){e[n]=t[n]}}return e}function sglGetBufferOptions(e,t){var n={usage:e.STATIC_DRAW};return _sglConsolidateOptions(n,t)}function SglBufferInfo(){this.handle=null;this.valid=false;this.target=0;this.size=0;this.usage=0}function sglBufferFromData(e,t,n,r){var i=sglGetBufferOptions(e,r);var s=e.createBuffer();e.bindBuffer(t,s);e.bufferData(t,n,i.usage);e.bindBuffer(t,null);var o=new SglBufferInfo;o.handle=s;o.valid=true;o.target=t;o.size=n.sizeInBytes;o.usage=i.usage;return o}function sglVertexBufferFromData(e,t,n){return sglBufferFromData(e,e.ARRAY_BUFFER,t,n)}function sglIndexBufferFromData(e,t,n){return sglBufferFromData(e,e.ELEMENT_ARRAY_BUFFER,t,n)}function SglShaderInfo(){this.handle=null;this.valid=false;this.type=0;this.log=""}function sglShaderFromSource(e,t,n){var r="";r+="----------------------\n";var i=e.createShader(t);e.shaderSource(i,n);e.compileShader(i);r+="[SHADER LOG]\n";var s=true;if(e.getShaderParameter(i,e.COMPILE_STATUS)!=0){r+="SUCCESS:\n"}else{s=false;r+="FAIL:\n"}r+=e.getShaderInfoLog(i);r+="\n";r+="----------------------\n";var o=new SglShaderInfo;o.handle=i;o.valid=s;o.type=t;o.log=r;return o}function sglVertexShaderFromSource(e,t){return sglShaderFromSource(e,e.VERTEX_SHADER,t)}function sglFragmentShaderFromSource(e,t){return sglShaderFromSource(e,e.FRAGMENT_SHADER,t)}function SglProgramAttributeInfo(){this.name="";this.nativeType=0;this.size=0;this.location=-1}function SglProgramUniformInfo(){this.name="";this.nativeType=0;this.size=0;this.location=-1}function SglProgramSamplerInfo(){this.name="";this.nativeType=0;this.size=0;this.location=-1}function SglProgramInfo(){this.handle=null;this.valid=false;this.shaders=[];this.attributes=new Object;this.uniforms=new Object;this.samplers=new Object;this.log=""}function sglProgramFromShaders(e,t){var n="";n+="----------------------\n";var r=e.createProgram();for(var i in t){var s=t[i];e.attachShader(r,s.handle)}e.linkProgram(r);var o=true;o=o&&e.getProgramParameter(r,e.LINK_STATUS)!=0;n+="[PROGRAM LOG]\n";if(o){n+="SUCCESS:\n"}else{n+="FAIL:\n"}n+=e.getProgramInfoLog(r);n+="\n";n+="----------------------\n";var u=new SglProgramInfo;u.handle=r;u.valid=o;for(var i in t){var s=t[i];u.shaders.push(s)}u.log=n;var a=e.getProgramParameter(r,e.ACTIVE_ATTRIBUTES);var f,l,c;for(var h=0;h<a;++h){f=e.getActiveAttrib(r,h);if(!f)continue;c=new SglProgramAttributeInfo;c.name=f.name;c.nativeType=f.type;c.size=f.size;c.location=e.getAttribLocation(r,f.name);u.attributes[c.name]=c}var p=e.getProgramParameter(r,e.ACTIVE_UNIFORMS);var d,l,v;for(var h=0;h<p;++h){d=e.getActiveUniform(r,h);if(!d)continue;l=e.getUniformLocation(r,d.name);if(d.type==e.SAMPLER_2D||d.type==e.SAMPLER_CUBE||d.type==35682){i=new SglProgramSamplerInfo;i.name=d.name;i.nativeType=d.type;i.size=d.size;i.location=l;u.samplers[i.name]=i}else{v=new SglProgramUniformInfo;v.name=d.name;v.nativeType=d.type;v.size=d.size;v.location=l;u.uniforms[v.name]=v}}sglSetDefaultProgramBindings(e,u);return u}function sglProgramFromSources(e,t,n){var r=null;var i=[];for(var s in t){var o=t[s];r=sglVertexShaderFromSource(e,o);i.push(r)}for(var s in n){var o=n[s];r=sglFragmentShaderFromSource(e,o);i.push(r)}return sglProgramFromShaders(e,i)}function sglSetDefaultProgramBindings(e,t){var n=t.handle;var r=0;for(var i in t.attributes){var s=t.attributes[i];e.bindAttribLocation(n,r,s.name);s.location=r;r++}e.linkProgram(n);for(var o in t.uniforms){var u=t.uniforms[o];u.location=e.getUniformLocation(n,u.name)}e.useProgram(t.handle);var a=0;for(var f in t.samplers){var l=t.samplers[f];l.location=e.getUniformLocation(n,l.name);e.uniform1i(l.location,a);a++}}function sglProgramSynchronize(e,t){var n=t.handle;for(var r in t.attributes){var i=t.attributes[r];i.location=e.getAttribLocation(n,i.name)}for(var s in t.uniforms){var o=t.uniforms[s];o.location=e.getUniformLocation(n,o.name)}for(var u in t.samplers){var a=t.samplers[u];a.location=e.getUniformLocation(n,a.name)}}function sglGetTextureOptions(e,t){var n={minFilter:e.LINEAR,magFilter:e.LINEAR,wrapS:e.CLAMP_TO_EDGE,wrapT:e.CLAMP_TO_EDGE,isDepth:false,depthMode:e.LUMINANCE,depthCompareMode:e.COMPARE_R_TO_TEXTURE,depthCompareFunc:e.LEQUAL,generateMipmap:false,flipY:true,premultiplyAlpha:false,onload:null};return _sglConsolidateOptions(n,t)}function SglTextureInfo(){this.handle=null;this.valid=false;this.target=0;this.format=0;this.width=0;this.height=0;this.minFilter=0;this.magFilter=0;this.wrapS=0;this.wrapT=0;this.isDepth=false;this.depthMode=0;this.depthCompareMode=0;this.depthCompareFunc=0}function sglTexture2DFromData(e,t,n,r,i,s,o,u){var a=sglGetTextureOptions(e,u);if(!o){if(s==e.FLOAT){o=new Float32Array(n*r*4)}else{o=new Uint8Array(n*r*4)}}var f=e.createTexture();e.bindTexture(e.TEXTURE_2D,f);var l=e.getParameter(e.UNPACK_FLIP_Y_WEBGL);var c=a.flipY===true;if(l!=c){e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,c?1:0)}e.texImage2D(e.TEXTURE_2D,0,t,n,r,0,i,s,o);if(l!=c){e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,l?1:0)}e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,a.minFilter);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,a.magFilter);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,a.wrapS);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,a.wrapT);if(a.isDepth){e.texParameteri(e.TEXTURE_2D,e.DEPTH_TEXTURE_MODE,a.depthMode);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_COMPARE_MODE,a.depthCompareMode);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_COMPARE_FUNC,a.depthCompareFunc)}if(a.generateMipmap){e.generateMipmap(e.TEXTURE_2D)}e.bindTexture(e.TEXTURE_2D,null);var h=new SglTextureInfo;h.handle=f;h.valid=true;h.target=e.TEXTURE_2D;h.format=t;h.width=n;h.height=r;h.minFilter=a.minFilter;h.magFilter=a.magFilter;h.wrapS=a.wrapS;h.wrapT=a.wrapT;h.isDepth=a.isDepth;h.depthMode=a.depthMode;h.depthCompareMode=a.depthCompareMode;h.depthCompareFunc=a.depthCompareFunc;return h}function sglTexture2DFromImage(e,t,n){var r=sglGetTextureOptions(e,n);var i=e.createTexture();e.bindTexture(e.TEXTURE_2D,i);var s=e.getParameter(e.UNPACK_FLIP_Y_WEBGL);var o=r.flipY===true;if(s!=o){e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,o?1:0)}e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t);if(s!=o){e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,s?1:0)}e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r.minFilter);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r.magFilter);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,r.wrapS);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,r.wrapT);if(r.generateMipmap){e.generateMipmap(e.TEXTURE_2D)}e.bindTexture(e.TEXTURE_2D,null);var u=new SglTextureInfo;u.handle=i;u.valid=true;u.target=e.TEXTURE_2D;u.format=e.RGBA;u.width=t.width;u.height=t.height;u.minFilter=r.minFilter;u.magFilter=r.magFilter;u.wrapS=r.wrapS;u.wrapT=r.wrapT;u.isDepth=false;u.depthMode=0;u.depthCompareMode=0;u.depthCompareFunc=0;return u}function sglTexture2DFromUrl(e,t,n){var r=sglGetTextureOptions(e,n);var i=new SglTextureInfo;var s=new Image;s.onload=function(){var n=sglTexture2DFromImage(e,s,r);for(var o in n){i[o]=n[o]}if(r.onload){r.onload(e,i,t)}};s.src=t;return i}function sglTextureCubeFromData(e,t,n,r,i,s,o,u){var a=sglGetTextureOptions(e,u);if(!o){var f=null;if(s==e.FLOAT){f=new Float32Array(n*r*4)}else{f=new Uint8Array(n*r*4)}o=new Array(6);for(var l=0;l<6;++l){o[l]=f}}var c=e.createTexture();e.bindTexture(e.TEXTURE_CUBE_MAP,c);var h=e.getParameter(e.UNPACK_FLIP_Y_WEBGL);var p=a.flipY===true;if(h!=p){e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,p?1:0)}for(var l=0;l<6;++l){e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,t,n,r,0,i,s,o[l])}if(h!=p){e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,h?1:0)}e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,a.minFilter);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,a.magFilter);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,a.wrapS);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,a.wrapT);if(a.isDepth){e.texParameteri(e.TEXTURE_CUBE_MAP,e.DEPTH_TEXTURE_MODE,a.depthMode);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_COMPARE_MODE,a.depthCompareMode);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_COMPARE_FUNC,a.depthCompareFunc)}if(a.generateMipmap){e.generateMipmap(e.TEXTURE_CUBE_MAP)}e.bindTexture(e.TEXTURE_CUBE_MAP,null);var d=new SglTextureInfo;d.handle=c;d.valid=true;d.target=e.TEXTURE_CUBE_MAP;d.format=t;d.width=n;d.height=r;d.minFilter=a.minFilter;d.magFilter=a.magFilter;d.wrapS=a.wrapS;d.wrapT=a.wrapT;d.isDepth=a.isDepth;d.depthMode=a.depthMode;d.depthCompareMode=a.depthCompareMode;d.depthCompareFunc=a.depthCompareFunc;return d}function sglTextureCubeFromImages(e,t,n){var r=sglGetTextureOptions(e,n);var i=e.createTexture();e.bindTexture(e.TEXTURE_CUBE_MAP,i);var s=e.getParameter(e.UNPACK_FLIP_Y_WEBGL);var o=r.flipY===true;if(s!=o){e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,o?1:0)}for(var u=0;u<6;++u){e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+u,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t[u])}if(s!=o){e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,s?1:0)}e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,r.minFilter);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,r.magFilter);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,r.wrapS);e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,r.wrapT);if(r.generateMipmap){e.generateMipmap(e.TEXTURE_CUBE_MAP)}e.bindTexture(e.TEXTURE_CUBE_MAP,null);var a=new SglTextureInfo;a.handle=i;a.valid=true;a.target=e.TEXTURE_CUBE_MAP;a.format=e.RGBA;a.width=t[0].width;a.height=t[0].height;a.minFilter=r.minFilter;a.magFilter=r.magFilter;a.wrapS=r.wrapS;a.wrapT=r.wrapT;a.isDepth=false;a.depthMode=0;a.depthCompareMode=0;a.depthCompareFunc=0;return a}function sglTextureCubeFromUrls(e,t,n){var r=sglGetTextureOptions(e,n);var i=new SglTextureInfo;var s=6;var o=new Array(6);for(var u=0;u<6;++u){o[u]=new Image}var a=function(){s--;if(s==0){var n=sglTextureCubeFromImages(e,o,r);for(var u in n){i[u]=n[u]}if(r.onload){r.onload(e,i,t)}}};for(var u=0;u<6;++u){o[u].onload=a;o[u].src=t[u]}return i}function SglRenderbufferInfo(){this.handle=null;this.valid=false;this.target=0;this.format=0;this.width=0;this.height=0}function sglRenderbufferFromFormat(e,t,n,r){var i=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,i);e.renderbufferStorage(e.RENDERBUFFER,t,n,r);e.bindRenderbuffer(e.RENDERBUFFER,null);var s=new SglRenderbufferInfo;s.handle=i;s.valid=true;s.target=e.RENDERBUFFER;s.format=t;s.width=n;s.height=r;return s}function sglGetFramebufferOptions(e,t){var n={minFilter:e.LINEAR,magFilter:e.LINEAR,wrapS:e.CLAMP_TO_EDGE,wrapT:e.CLAMP_TO_EDGE,isDepth:false,depthMode:e.LUMINANCE,depthCompareMode:e.COMPARE_R_TO_TEXTURE,depthCompareFunc:e.LEQUAL,colorsAsRenderbuffer:false,depthAsRenderbuffer:false,stencilAsRenderbuffer:false,generateColorsMipmap:false,generateDepthMipmap:false,generateStencilMipmap:false};return _sglConsolidateOptions(n,t)}function SglFramebufferInfo(){this.handle=null;this.valid=false;this.width=0;this.height=0;this.colorTargets=[];this.depthTarget=null;this.stencilTarget=null;this.status=0}function sglFramebufferFromTargets(e,t,n,r,i){var s=sglGetFramebufferOptions(e,i);var o=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,o);if(n!=undefined&&n!=null&&n!=e.NONE){if(n.target==e.TEXTURE_2D){e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,n.handle,0)}else if(n.target==e.RENDERBUFFER){e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,n.handle)}}if(r!=undefined&&r!=null&&r!=e.NONE){if(r.target==e.TEXTURE_2D){e.framebufferTexture2D(e.FRAMEBUFFER,e.STENCIL_ATTACHMENT,e.TEXTURE_2D,r.handle,0)}else if(r.target==e.RENDERBUFFER){e.framebufferRenderbuffer(e.FRAMEBUFFER,e.STENCIL_ATTACHMENT,e.RENDERBUFFER,r.handle)}}var u=[];var a=[];if(t!=undefined&&t!=null){var f=t.length;if(f==0){a.push(e.NONE)}else{var l=e.COLOR_ATTACHMENT0;for(var c in t){var h=t[c];if(h.target==e.TEXTURE_2D){e.framebufferTexture2D(e.FRAMEBUFFER,l,e.TEXTURE_2D,h.handle,0)}else if(h.target==e.RENDERBUFFER){e.framebufferRenderbuffer(e.FRAMEBUFFER,l,e.RENDERBUFFER,h.handle)}a.push(l);u.push(h);l++}}}var p=e.checkFramebufferStatus(e.FRAMEBUFFER);e.bindFramebuffer(e.FRAMEBUFFER,null);var d=null;if(u.length>0){d=u[0]}else if(n){d=n}else if(r){d=r}var v=0;var m=0;if(d){v=d.width;m=d.height}var g=new SglFramebufferInfo;g.handle=o;g.valid=p==e.FRAMEBUFFER_COMPLETE;g.width=v;g.height=m;g.colorTargets=u;g.depthTarget=n?n:null;g.stencilTarget=r?r:null;g.status=p;return g}function sglFramebufferFromFormats(e,t,n,r,i,s,o){var u=sglGetFramebufferOptions(e,o);var a=null;if(r){u.isDepth=false;a=[];var f=null;if(u.colorsAsRenderbuffer){for(var l in r){var c=r[l];f=sglRenderbufferFromFormat(e,c,t,n);a.push(f)}}else{u.generateMipmap=u.generateColorsMipmap;for(var l in r){var c=r[l];f=sglTexture2DFromData(e,c,t,n,e.RGBA,e.UNSIGNED_BYTE,null,u);a.push(f)}}}var h=null;if(i){u.isDepth=true;if(u.depthAsRenderbuffer){h=sglRenderbufferFromFormat(e,i,t,n)}else{u.generateMipmap=u.generateDepthMipmap;h=sglTexture2DFromData(e,i,t,n,e.DEPTH_COMPONENT,e.FLOAT,null,u)}}var p=null;if(s){u.isDepth=false;if(u.stencilAsRenderbuffer){p=sglRenderbufferFromFormat(e,s,t,n)}else{u.generateMipmap=u.generateStencilMipmap;p=sglTexture2DFromData(e,s,t,n,e.STENCIL_COMPONENT,e.UNSIGNED_BYTE,null,u)}}return sglFramebufferFromTargets(e,a,h,p,u)}function SglVertexBuffer(){this.gl=arguments[0];this._info=null;if(arguments[1]instanceof SglBufferInfo){this._info=arguments[1]}else{this._info=sglVertexBufferFromData(this.gl,arguments[1],arguments[2])}}function SglIndexBuffer(){this.gl=arguments[0];this._info=null;if(arguments[1]instanceof SglBufferInfo){this._info=arguments[1]}else{this._info=sglIndexBufferFromData(this.gl,arguments[1],arguments[2])}}function SglProgramAttribute(e,t){this._prog=e;this._info=t}function SglProgramUniform(e,t){this._prog=e;this._info=t;this._func=null;var n=this._prog.gl;var r=this._info.nativeType;if(r==n.BOOL){this._func=function(e){this._prog.gl.uniform1i(this._info.location,e)}}else if(r==n.BOOL_VEC2){this._func=function(e){this._prog.gl.uniform2iv(this._info.location,e)}}else if(r==n.BOOL_VEC3){this._func=function(e){this._prog.gl.uniform3iv(this._info.location,e)}}else if(r==n.BOOL_VEC4){this._func=function(e){this._prog.gl.uniform4iv(this._info.location,e)}}else if(r==n.INT){this._func=function(e){this._prog.gl.uniform1i(this._info.location,e)}}else if(r==n.INT_VEC2){this._func=function(e){this._prog.gl.uniform2iv(this._info.location,e)}}else if(r==n.INT_VEC3){this._func=function(e){this._prog.gl.uniform3iv(this._info.location,e)}}else if(r==n.INT_VEC4){this._func=function(e){this._prog.gl.uniform4iv(this._info.location,e)}}else if(r==n.FLOAT){this._func=function(e){this._prog.gl.uniform1f(this._info.location,e)}}else if(r==n.FLOAT_VEC2){this._func=function(e){this._prog.gl.uniform2fv(this._info.location,e)}}else if(r==n.FLOAT_VEC3){this._func=function(e){this._prog.gl.uniform3fv(this._info.location,e)}}else if(r==n.FLOAT_VEC4){this._func=function(e){this._prog.gl.uniform4fv(this._info.location,e)}}else if(r==n.FLOAT_MAT2){this._func=function(e){this._prog.gl.uniformMatrix2fv(this._info.location,this._prog.gl.FALSE,e)}}else if(r==n.FLOAT_MAT3){this._func=function(e){this._prog.gl.uniformMatrix3fv(this._info.location,this._prog.gl.FALSE,e)}}else if(r==n.FLOAT_MAT4){this._func=function(e){this._prog.gl.uniformMatrix4fv(this._info.location,this._prog.gl.FALSE,e)}}else{sglUnknown()}}function SglProgramSampler(e,t){this._prog=e;this._info=t;this._unit=-1;var n=this._prog.gl;var r=this._info.nativeType;if(r==n.SAMPLER_2D){}else if(r==n.SAMPLER_CUBE){}else if(r==35682){}else{sglUnknown()}}function SglProgram(){this.gl=arguments[0];this._info=null;if(arguments[1]instanceof SglProgramInfo){this._info=arguments[1]}else{this._info=sglProgramFromSources(this.gl,arguments[1],arguments[2])}this._attributes=new Object;for(var e in this._info.attributes){this._attributes[e]=new SglProgramAttribute(this,this._info.attributes[e])}this._uniforms=new Object;for(var t in this._info.uniforms){this._uniforms[t]=new SglProgramUniform(this,this._info.uniforms[t])}var n=0;this._samplers=new Object;for(var r in this._info.samplers){this._samplers[r]=new SglProgramSampler(this,this._info.samplers[r]);this._samplers[r]._unit=n;n++}}function SglTexture2D(){this.gl=arguments[0];this._info=null;var e=this.gl;var t=arguments.length;if(t==2||t==3){if(arguments[1]instanceof Image){this._info=sglTexture2DFromImage(e,arguments[1],arguments[2])}else if(typeof arguments[1]=="string"){this._info=sglTexture2DFromUrl(e,arguments[1],arguments[2])}else{this._info=arguments[1]}}else{this._info=sglTexture2DFromData(e,arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}}function SglTextureCube(){this.gl=arguments[0];this._info=null;var e=this.gl;var t=arguments.length;if(t==2||t==3){if(arguments[1]instanceof Array){if(arguments[1][0]instanceof Image){this._info=sglTextureCubeFromImages(e,arguments[1],arguments[2])}else if(typeof arguments[1][0]=="string"){this._info=sglTextureCubeFromUrls(e,arguments[1],arguments[2])}}else{this._info=arguments[1]}}else{this._info=sglTextureCubeFromData(e,arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}}function SglRenderbuffer(){this.gl=arguments[0];this._info=null;var e=this.gl;var t=arguments.length;if(t==2){this._info=arguments[1]}else{this._info=sglRenderbufferFromFormat(e,arguments[1],arguments[2],arguments[3])}}function SglFramebuffer(){this.gl=arguments[0];this._info=null;var e=this.gl;var t=arguments.length;if(t==2){this._info=arguments[1]}else{this._info=sglFramebufferFromFormats(e,arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6])}var n=null;var r=null;this._colorTargets=[];for(var i in this._info.colorTargets){n=this._info.colorTargets[i];r=null;if(n.target==e.TEXTURE_2D){r=new SglTexture2D(e,n)}else if(n.target==e.RENDERBUFFER){r=new SglRenderbuffer(e,n)}this._colorTargets.push(r)}this._depthTarget=null;if(this._info.depthTarget){n=this._info.depthTarget;r=null;if(n.target==e.TEXTURE_2D){r=new SglTexture2D(e,n)}else if(n.target==e.RENDERBUFFER){r=new SglRenderbuffer(e,n)}this._depthTarget=r}this._stencilTarget=null;if(this._info.stencilTarget){n=this._info.stencilTarget;r=null;if(n.target==e.TEXTURE_2D){r=new SglTexture2D(e,n)}else if(n.target==e.RENDERBUFFER){r=new SglRenderbuffer(e,n)}this._stencilTarget=r}}function SglAttributeStreamJS(e,t,n,r){this._name=e;this._size=t;this._buff=r?n?n.slice():null:n}function SglVertexStreamJS(){this._attribs={};this._length=0}function SglPrimitiveStreamJS(e,t,n,r){this._name=e;this._mode=t;this._first=n?n:0;this._length=r?r:0}function SglArrayPrimitiveStreamJS(e,t,n,r){SglPrimitiveStreamJS.call(this,e,t,n,r);Object.defineProperty(this,"type",{get:function(){return SGL_ARRAY_PRIMITIVE_STREAM}})}function SglIndexedPrimitiveStreamJS(e,t,n,r){SglPrimitiveStreamJS.call(this,e,t,0,n.length);this._buff=r?n?n.slice():null:n;Object.defineProperty(this,"type",{get:function(){return SGL_INDEXED_PRIMITIVE_STREAM}});Object.defineProperty(this,"buffer",{get:function(){return this._buff}});Object.defineProperty(this,"length",{get:function(){return this._buff.length}})}function SglConnectivityJS(){this._prims={}}function SglMeshJS(){this._valid=false;this._vert=new SglVertexStreamJS;this._conn=new SglConnectivityJS}function sglMeshJSImportOBJFromString(e,t){var n=[];var r=[];var i=[];var s=[];var o=[];var u=[];var a=[];var f={};var l=0;var c=null;var h=null;var p=0;var d=0;var v=0;var m=0;var g=0;var y=0;var b=null;var w=false;var E=false;var S=false;var x=t.split("\n");for(var T in x){c=x[T].replace(/[ \t]+/g," ").replace(/\s\s*$/,"");if(c[0]=="#")continue;b=c.split(" ");if(b[0]=="v"){o.push(parseFloat(b[1]));o.push(parseFloat(b[2]));o.push(parseFloat(b[3]))}else if(b[0]=="vt"){u.push(parseFloat(b[1]));u.push(parseFloat(b[2]))}else if(b[0]=="vn"){a.push(parseFloat(b[1]));a.push(parseFloat(b[2]));a.push(parseFloat(b[3]))}else if(b[0]=="f"){if(b.length!=4)continue;for(var N=1;N<4;++N){if(!(b[N]in f)){h=b[N].split("/");if(h.length==1){p=parseInt(h[0])-1;d=p;v=p}else if(h.length==3){p=parseInt(h[0])-1;d=parseInt(h[1])-1;v=parseInt(h[2])-1}else{return false}m=0;g=0;y=0;if(p*3+2<o.length){w=true;m=o[p*3+0];g=o[p*3+1];y=o[p*3+2]}n.push(m);n.push(g);n.push(y);m=0;g=0;if(d*2+1<u.length){E=true;m=u[d*2+0];g=u[d*2+1]}r.push(m);r.push(g);m=0;g=0;y=1;if(v*3+2<a.length){S=true;m=a[v*3+0];g=a[v*3+1];y=a[v*3+2]}i.push(m);i.push(g);i.push(y);f[b[N]]=l++}s.push(f[b[N]])}}}if(w){e.addVertexAttribute("position",3,n,false)}if(S){e.addVertexAttribute("normal",3,i,false)}if(E){e.addVertexAttribute("texcoord",2,r,false)}if(s.length>0){e.addIndexedPrimitives("triangles",SGL_TRIANGLES_LIST,s,false)}return true}function sglMeshJSImportOBJFromURL(e,t,n,r){e.isValid=false;if(!n){var i=sglLoadFile(t);e.isValid=sglMeshJSImportOBJFromString(e,i);if(r){r(e,t)}return e.isValid}sglLoadFile(t,function(n){e.isValid=sglMeshJSImportOBJFromString(e,n);if(r){r(e,t)}});return true}function _sglFindVertexAttributeJSON(e,t){for(var n in e.vertices){if(e.vertices[n].name===t){return e.vertices[n]}}return null}function _sglFindConnectivityJSON(e,t){for(var n in e.connectivity){if(e.connectivity[n].name===t){return e.connectivity[n]}}return null}function sglMeshJSImportJSONFromString(e,t){var n=JSON.parse(t);if(!n)return false;var r=n.mapping;var i=null;for(var s in r){if(r[s].name==="standard"){i=r[s];break}}if(!i)return false;for(var o in i.attributes){var u=i.attributes[o];var a=_sglFindVertexAttributeJSON(n,u.source);if(!a)continue;if(a.normalized){for(var f=0,l=a.values.length;f<l;++f){a.values[f]/=255}}e.addVertexAttribute(u.semantic,a.size,a.values,false)}var c=_sglFindConnectivityJSON(n,i.primitives);if(!c)return false;e.addIndexedPrimitives(c.name,SGL_TRIANGLES_LIST,c.indices,false);return true}function sglMeshJSImportJSONFromURL(e,t,n,r){e.isValid=false;if(!n){var i=sglLoadFile(t);e.isValid=sglMeshJSImportJSONFromString(e,i);if(r){r(e,t)}return e.isValid}sglLoadFile(t,function(n){e.isValid=sglMeshJSImportJSONFromString(e,n);if(r){r(e,t)}});return true}function sglGLTypeSize(e,t){if(t==e.BYTE)return 1;if(t==e.UNSIGNED_BYTE)return 1;if(t==e.SHORT)return 2;if(t==e.UNSIGNED_SHORT)return 2;if(t==e.INT)return 4;if(t==e.UNSIGNED_INT)return 4;if(t==e.FLOAT)return 4;return null}function sglGLTypeFromWebGLArray(e,t){if(t instanceof Int8Array)return e.BYTE;if(t instanceof Uint8Array)return e.UNSIGNED_BYTE;if(t instanceof Int16Array)return e.SHORT;if(t instanceof Uint16Array)return e.UNSIGNED_SHORT;if(t instanceof Int32Array)return e.INT;if(t instanceof Uint32Array)return e.UNSIGNED_INT;if(t instanceof Float32Array)return e.FLOAT;return null}function SglAttributeStreamGL(e,t,n,r,i){var s=sglGLTypeFromWebGLArray(e,r);var o=sglGLTypeSize(e,s)*n;this.gl=e;this._name=t;this._size=n;this._type=s;this._norm=i?true:false;this._stride=o;this._offset=0;this._length=r.length/n;this._buff=new SglVertexBuffer(e,r,{usage:e.STATIC_DRAW})}function SglVertexStreamGL(e){this.gl=e;this._attribs=new Object;this._length=0}function SglPrimitiveStreamGL(e,t,n,r,i){this.gl=e;this._name=t;this._mode=n;this._first=r?r:0;this._length=i?i:0}function SglArrayPrimitiveStreamGL(e,t,n,r,i){SglPrimitiveStreamGL.call(this,e,t,n,r,i);Object.defineProperty(this,"type",{get:function(){return SGL_ARRAY_PRIMITIVE_STREAM}})}function SglIndexedPrimitiveStreamGL(e,t,n,r){SglPrimitiveStreamGL.call(this,e,t,n,0,r.length);var i=sglGLTypeFromWebGLArray(e,r);var s=sglGLTypeSize(e,i);this._idxType=i;this._stride=s;this._buff=new SglIndexBuffer(e,r,{usage:e.STATIC_DRAW});Object.defineProperty(this,"indexType",{get:function(){return this._idxType}});Object.defineProperty(this,"stride",{get:function(){return this._stride}});Object.defineProperty(this,"type",{get:function(){return SGL_INDEXED_PRIMITIVE_STREAM}})}function SglPackedIndexedPrimitiveStreamGL(e,t,n,r,i,s){if(i.length!=s.length){sglInvalidParameter()}SglPrimitiveStreamGL.call(this,e,t,n,0,r.length);var o=sglGLTypeFromWebGLArray(e,r);var u=sglGLTypeSize(e,o);this._idxType=o;this._stride=u;this._buff=new SglIndexBuffer(e,r,{usage:e.STATIC_DRAW});this._blockStartingVertices=s.slice();var a=this._blockStartingVertices.length;this._blockStartingIndices=i.slice();this._blockIndicesCount=new Array(a);var f=this._blockStartingIndices[0];for(var l=0;l<a-1;++l){var c=this._blockStartingIndices[l+1];this._blockIndicesCount[l]=c-f;f=c}this._blockIndicesCount[a-1]=r.length-f;Object.defineProperty(this,"isPacked",{get:function(){return true}});Object.defineProperty(this,"indexType",{get:function(){return this._idxType}});Object.defineProperty(this,"stride",{get:function(){return this._stride}});Object.defineProperty(this,"type",{get:function(){return SGL_PACKED_INDEXED_PRIMITIVE_STREAM}});Object.defineProperty(this,"blocksCount",{get:function(){return this._blockStartingIndices.length}});Object.defineProperty(this,"blockStartingVertices",{get:function(){return this._blockStartingVertices}});Object.defineProperty(this,"blockIndicesCount",{get:function(){return this._blockIndicesCount}})}function SglConnectivityGL(e){this.gl=e;this._prims=new Object}function SglMeshGL(e){this.gl=e;this._vert=new SglVertexStreamGL(this.gl);this._conn=new SglConnectivityGL(this.gl)}function SglMeshGLRenderer(e,t){this._prog=e;this._mapping=null;this._meshAttrMap=null;this._mesh=null;this._primStream=null;this._phase=0;this._updateEnabledVB=false;if(t){this.synchronizeProgram()}this.setStreamMapping()}function sglRenderMeshGLPrimitives(e,t,n,r,i,s,o,u){var a=new SglMeshGLRenderer(n);a.begin();if(r)a.setStreamMapping(r);if(i)a.setUniforms(i);if(s)a.setSamplers(s);if(t){a.renderMeshPrimitives(e,t,o,u)}else{var f=e.connectivity.primitives;for(var l in f){a.renderMeshPrimitives(e,l,o,u)}}}function sglMeshJSCalculateBBox(e,t){var n=t||"position";var r=e.vertices.attributes[n];var i=r.size;var s=r.buffer;var o=new SglBox3;if(i!=3)return o;var u=s.length/i;if(u<=0)return o;u*=i;for(var a=0;a<i;++a){o.min[a]=s[a];o.max[a]=s[a]}var f=0;for(var l=i;l<u;l+=i){for(var a=0;a<i;++a){f=s[l+a];if(o.min[a]>f)o.min[a]=f;if(o.max[a]<f)o.max[a]=f}}return o}function sglGLPrimitiveType(e,t){switch(t){case SGL_POINTS_LIST:return e.POINTS;break;case SGL_LINES_LIST:return e.LINES;break;case SGL_LINE_STRIP:return e.LINE_STRIP;break;case SGL_LINE_LOOP:return e.LINE_LOOP;break;case SGL_TRIANGLES_LIST:return e.TRIANGLES;break;case SGL_TRIANGLE_STRIP:return e.TRIANGLE_STRIP;break;case SGL_TRIANGLE_FAN:return e.TRIANGLE_FAN;break;default:return undefined;break}return undefined}function sglMeshJStoGL(e,t){var n=new SglMeshGL(e);for(a in t.vertices.attributes){var r=t.vertices.attributes[a];n.addVertexAttribute(r.name,r.size,new Float32Array(r.buffer))}for(p in t.connectivity.primitives){var i=t.connectivity.primitives[p];var s=sglGLPrimitiveType(n.gl,i.mode);if(s==undefined)continue;switch(i.type){case SGL_ARRAY_PRIMITIVE_STREAM:n.addArrayPrimitives(i.name,s,i.first,i.length);break;case SGL_INDEXED_PRIMITIVE_STREAM:n.addIndexedPrimitives(i.name,s,new Uint16Array(i.buffer));break;default:break}}return n}function sglPackMeshJStoGL(e,t,n,r){var i=n||"triangles";var s=r||65e3;var o=t.connectivity.primitives[i];if(!o)return null;if(o.type!=SGL_INDEXED_PRIMITIVE_STREAM)return null;var u=sglGLPrimitiveType(e,o.mode);if(u==undefined)return null;var a=0;if(u===e.TRIANGLES){a=3}else if(u===e.LINES){a=2}else if(u===e.POINTS){a=1}else{return null}var f=[];var l=o.buffer;var c=l.length;c-=c%a;var h=0;var p=0;var d=0;var v=[];var m=[];var g=[];var y={};for(var b in t.vertices.attributes){var w=t.vertices.attributes[b];y[b]={name:w.name,size:w.size,buffer:[]}}while(h<c){var E={};var S=[];var x=0;var E={};var x=0;for(var T=h;T<c;T+=a){var N={};var C=0;for(var k=0;k<a;++k){var L=l[T+k];if(N[L]==undefined){N[L]=true;if(E[L]==undefined){C++}}}if(x+C<=s){for(var k=0;k<a;++k){var L=l[T+k];var A=E[L];if(A==undefined){E[L]=x;A=x;x++}S.push(A)}h+=a}else{break}}if(x<=0)break;var O=S.length;for(var b in t.vertices.attributes){var M=t.vertices.attributes[b];var _=y[b];var D=M.size;var P=_.buffer.length;var H=new Array(x*D);_.buffer=_.buffer.concat(H);var B=M.buffer;var j=_.buffer;for(var T in E){var A=E[T];for(var F=0;F<D;++F){j[P+(A*D+F)]=B[T*D+F]}}}g=g.concat(S);v.push(p);m.push(d);p+=x;d+=O}var I=new SglMeshGL(e);for(var b in y){var w=y[b];I.addVertexAttribute(w.name,w.size,new Float32Array(w.buffer))}if(v.length==1){I.addIndexedPrimitives(i,u,new Uint16Array(g))}else{I.addPackedIndexedPrimitives(i,u,new Uint16Array(g),m,v)}return I}function SglTrackball(){this._matrix=sglIdentityM4();this._pts=[[0,0],[0,0]];this._action=SGL_TRACKBALL_NO_ACTION;this.reset()}function SglFirstPersonCamera(){this._position=sglZeroV3();this._angles=sglZeroV3();this.lookAt(0,0,0,0,0,-1,0)}function sglGetCanvasContext(e){var t=document.getElementById(e);if(!t)return null;var n=["webgl","experimental-webgl","moz-webgl","webkit-3d"];var r=null;for(var i=0;i<n.length;i++){try{r=t.getContext(n[i])}catch(s){r=null}if(r)break}if(r==null)return null;if(r.FALSE==undefined)r.FALSE=0;if(r.TRUE==undefined)r.TRUE=1;return r}function SglCanvasUI(e,t,n,r){this._manager=e;this._handler=t;this._canvas=n;this._timerID=null;this._updRate=0;this._ignoreKeyRepeat=true;this.gl=r;this.loadEvent=null;this.unloadEvent=null;this.keyDownEvent=null;this.keyUpEvent=null;this.keyPressEvent=null;this.mouseDownEvent=null;this.mouseUpEvent=null;this.mouseMoveEvent=null;this.mouseWheelEvent=null;this.clickEvent=null;this.dblClickEvent=null;this.resizeEvent=null;this.updateEvent=null;this.drawEvent=null;this.keysDown=new Object;this.mouseButtonsDown=new Object;this.mousePos={x:0,y:0};this.mousePrevPos={x:0,y:0};this.mouseDeltaPos={x:0,y:0};this.timeNow=Date.now()/1e3;this.timePrev=this.timeNow;this.timeDelta=0}function _SglCanvasManager(e,t,n){var r=document.getElementById(e);if(!r)throw new Error("SpiderGL : Canvas not found");r.contentEditable=true;var i=sglGetCanvasContext(e);if(!i)throw new Error("SpiderGL : Cannot get WebGL context");i.pixelStorei(i.PACK_ALIGNMENT,1);i.pixelStorei(i.UNPACK_ALIGNMENT,1);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,true);i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,i.NONE);i.bindFramebuffer(i.FRAMEBUFFER,null);var s=new SglCanvasUI(this,t,r,i);this.ui=s;var o=this;this.gl=i;this.canvas=r;this.handler=t;this.handler.ui=s;this._drawPending=false;this.rendering=true;this._drawFunc=function(){o.draw()};this.canvas.addEventListener("load",function(e){o.load(e)},false);this.canvas.addEventListener("unload",function(e){o.unload(e)},false);this.canvas.addEventListener("keydown",function(e){o.keyDown(e)},false);this.canvas.addEventListener("keyup",function(e){o.keyUp(e)},false);this.canvas.addEventListener("keypress",function(e){o.keyPress(e)},false);this.canvas.addEventListener("mousedown",function(e){o.mouseDown(e)},false);this.canvas.addEventListener("mouseup",function(e){o.mouseUp(e)},false);this.canvas.addEventListener("mousemove",function(e){o.mouseMove(e)},false);this.canvas.addEventListener("click",function(e){o.click(e)},false);this.canvas.addEventListener("dblclick",function(e){o.dblClick(e)},false);this.canvas.addEventListener("resize",function(e){o.resize(e)},false);this.canvas.addEventListener("mousewheel",function(e){o.mouseWheel(e)},false);this.canvas.addEventListener("DOMMouseScroll",function(e){o.mouseWheel(e)},false);this.canvas.addEventListener("blur",function(e){o.blur(e)},false);this.canvas.addEventListener("mouseout",function(e){o.mouseOut(e)},false);this.canvas.addEventListener("mouseover",function(e){o.mouseOver(e)},false);this.load();if(n){this.ui.updateRate=n}}function _sglManageCanvas(e,t,n){var r=new _SglCanvasManager(e,t,n);_SGL_RegisteredCanvas[e]=r}function _sglUnmanageCanvas(e){if(_SGL_RegisteredCanvas[e]){_SGL_RegisteredCanvas[e]=null;delete _SGL_RegisteredCanvas[e]}}function _sglManageCanvasOnLoad(e,t,n){window.addEventListener("load",function(){_sglManageCanvas(e,t,n)},false)}function _sglUnmanageCanvasOnLoad(e){window.addEventListener("unload",function(){_sglUnmanageCanvas(e)},false)}function sglRegisterCanvas(e,t,n){_sglManageCanvasOnLoad(e,t,n);_sglUnmanageCanvasOnLoad(e)}function sglRegisterLoadedCanvas(e,t,n){_sglManageCanvas(e,t,n);_sglUnmanageCanvasOnLoad(e)}var SGL_VERSION_MAJOR=0;var SGL_VERSION_MINOR=1;var SGL_VERSION_REVISION=1;var SGL_VERSION_STRING=SGL_VERSION_MAJOR+"."+SGL_VERSION_MINOR+"."+SGL_VERSION_REVISION;window.addEventListener("load",function(){sglInitialize()},false);window.addEventListener("unload",function(){sglFinalize()},false);var SGL_REQUEST_FAILED=0;var SGL_REQUEST_SUCCEEDED=1;var SGL_REQUEST_IDLE=2;var SGL_REQUEST_ONGOING=3;var SGL_REQUEST_ABORTED=4;var SGL_REQUEST_QUEUED=5;var SGL_REQUEST_REJECTED=6;var SGL_REQUEST_CANCELLED=7;SglRequest.prototype={_createOnReadyCallback:function(){var e=this;var t=function(t){e._status=t?SGL_REQUEST_SUCCEEDED:SGL_REQUEST_FAILED;if(e._queue){e._queue._requestReady(e);this._queue=null}var n=e._onReady.length;for(var r=0;r<n;++r){e._onReady[r](e)}};return t},get status(){return this._status},get priority(){return this._priority},set priority(e){this._priority=e;if(this._queue){this._queue._updateRequest(this)}},get succeeded(){return this._status==SGL_REQUEST_SUCCEEDED},get failed(){return this._status==SGL_REQUEST_FAILED},addOnReadyCallback:function(e){if(e){this._onReady.push(e);if(this.isReady){e(this)}}},removeOnReadyCallback:function(e){var t=-1;var n=this._onReady.length;for(var r=0;r<n;++r){if(this._onReady[r]==e){t=r;break}}if(t<0)return;this._onReady.splice(t,1)},get isReady(){return this.failed||this.succeeded},get queue(){return this._queue},send:function(){if(!this._send)return false;var e=this._send();if(e){this._status=SGL_REQUEST_ONGOING}else{this._status=SGL_REQUEST_FAILED;var t=this._createOnReadyCallback();t(false)}return e},cancel:function(){if(this._status==SGL_REQUEST_QUEUED){if(this._queue){this._queue._removeQueuedRequest(this);this._queue=null}this._status=SGL_REQUEST_CANCELLED}},abort:function(){this.cancel();if(this._status==SGL_REQUEST_ONGOING){if(this._queue){this._queue._removeOngoingRequest(this);this._queue=null}if(this._abort){this._abort()}this._status=SGL_REQUEST_ABORTED}}};sglInherit(SglTextFileRequest,SglRequest);SglTextFileRequest.prototype._send=function(){if(!this._url)return false;var e=new XMLHttpRequest;this._req=e;var t=this._createOnReadyCallback();e.onreadystatechange=function(){if(e.readyState==4){var n=e.status?e.status==200:true;t(n)}};e.open("GET",this._url,true);e.send();return true};SglTextFileRequest.prototype._abort=function(){if(!this._req)return;this._req.abort()};sglInherit(SglImageRequest,SglRequest);SglImageRequest.prototype._send=function(){if(!this._url)return false;var e=new Image;this._img=e;var t=this._createOnReadyCallback();e.onload=function(){t(e.complete)};e.onerror=function(){t(false)};e.src=this._url;return true};SglImageRequest.prototype._abort=function(){};SglRequestWatcher.prototype={get requests(){return this._reqs},get succeeded(){return this._succeededReqs==this._reqs.length},get failed(){if(this._succeededReqs+this._failedReqs<this._reqs.length)return false;return this._succeededReqs<this._reqs.length},get onReady(){return this._onReady},set onReady(e){this._onReady=e;if(this.isReady){if(this._onReady){this._onReady(t)}}},get isReady(){return this._succeededReqs+this._failedReqs==this._reqs.length},send:function(){var e=this._reqs.length;for(var t=0;t<e;++t){this._reqs[t].send()}},cancel:function(){var e=this._reqs.length;for(var t=0;t<e;++t){this._reqs[t].cancel()}},abort:function(){var e=this._reqs.length;for(var t=0;t<e;++t){this._reqs[t].abort()}}};SglRequestQueue.prototype={_sort:function(){if(!this._dirty)return;this._dirty=false;this._minPriorityReq=null;if(this._queued.length<=0)return;if(this._priorityCompare){this._queued.sort(this._priorityCompare)}else{this._queued.sort()}if(this._queued.length>0){this._minPriorityReq=this._queued[0]}},_updateMinPriority:function(){this._minPriorityReq=null;var e=this._queued.length;if(e<=0)return;this._minPriorityReq=this._queued[0];if(!this._dirty)return;for(var t=1;t<e;++t){if(this.comparePriorities(this._queued[t].priority,this._minPriorityReq.priority)<=0){this._minPriorityReq=this._queued[t]}}},_removeFromArray:function(e,t){var n=-1;var r=e.length;for(var i=0;i<r;++i){if(e[i]==t){n=i;break}}if(n<0)return;e.splice(n,1)},_removeQueuedRequest:function(e){this._removeFromArray(this._queued,e);if(this._queued.length<=0){this._minPriorityReq=null}else if(e==this._minPriorityReq){this._updateMinPriority()}},_removeOngoingRequest:function(e){this._removeFromArray(this._ongoing,e);this._execute()},_updateRequest:function(e){if(this.comparePriorities(e.priority,this._minPriorityReq.priority)<=0){this._minPriorityReq=e}this._dirty=true},_requestReady:function(e){this._removeOngoingRequest(e);if(this._onReady){this._onReady(e)}this._execute()},_execute:function(){var e=this._queued.length;if(e<=0)return;var t=this._maxOngoing>0?this._maxOngoing-this._ongoing.length:e;if(t<=0)return;if(t>e)t=e;this._sort();var n=null;for(var r=0;r<t;++r){n=this._queued.pop();n.send()}if(this._queued.length>0){this._minPriorityReq=this._queued[0]}},comparePriorities:function(e,t){if(this._priorityCompare){return this._priorityCompare(e,t)}return e-t},get priorityCompare(){return this._priorityCompare},set priorityCompare(e){this._priorityCompare=e;this._updateMinPriority()},get onReady(){return this._onReady},set onReady(e){this._onReady=e},push:function(e){var t={victims:null,result:false};if(e.queue)return t;var n=this._queued.length;var r=this._maxQueued>0&&n>=this._maxQueued;if(r){if(this.comparePriorities(e.priority,this._minPriorityReq.priority)<=0){e._status=SGL_REQUEST_REJECTED;return t}}this._queued.push(e);e._queue=this;e._status=SGL_REQUEST_QUEUED;n++;t.result=true;var i=this._maxQueued>0?n-this._maxQueued:0;if(i<=0){if(this._minPriorityReq!=null){if(this.comparePriorities(e.priority,this._minPriorityReq.priority)<=0){this._minPriorityReq=e}}else{this._minPriorityReq=e}this._dirty=true}else{this._sort();t.victims=this._queued.slice(0,i);this._queued.splice(0,i);for(var s=0;s<i;++s){t.victims[s]._status=SGL_REQUEST_REJECTED;t.victims[s]._queue=null}}this._execute();return t}};var SGL_PI=Math.PI;SglVec2.prototype={clone:function(){return new SglVec2(this)},get copy(){return this.clone()},get x(){return this.v[0]},set x(e){this.v[0]=e},get y(){return this.v[1]},set y(e){this.v[1]=e},set:function(e,t){this.v[0]=e;this.v[1]=t;return this},setVec:function(e){return this.set(e[0],e[1])},setScalar:function(e){return this.set(e,e)},setZero:function(){return this.setScalar(0)},setOne:function(){return this.setScalar(1)},at:function(e){return this.v[e]},get squaredLength(){return this.dot(this)},get length(){return sglSqrt(this.squaredLength)},normalize:function(){var e=this.length;if(e>0)e=1/e;this.v[0]*=e;this.v[1]*=e;return this},get normalized(){return this.clone().normalize()},get neg(){return new SglVec2(-this.v[0],-this.v[1])},get abs(){return new SglVec2(sglAbs(this.v[0]),sglAbs(this.v[1]))},get minComp(){var e=this.v[0];if(e>this.v[1])e=this.v[1];return e},get maxComp(){var e=this.v[0];if(e<this.v[1])e=this.v[1];return e},get argMin(){var e=0;if(this.v[e]>this.v[1])e=1;return e},get argMax(){var e=0;if(this.v[e]>this.v[1])e=1;return e},add:function(e){return new SglVec2(this.v[0]+e.v[0],this.v[1]+e.v[1])},sub:function(e){return new SglVec2(this.v[0]-e.v[0],this.v[1]-e.v[1])},mul:function(e){return new SglVec2(this.v[0]*e.v[0],this.v[1]*e.v[1])},div:function(e){return new SglVec2(this.v[0]/e.v[0],this.v[1]/e.v[1])},get rcp(){return new SglVec2(1/this.v[0],1/this.v[1])},dot:function(e){return this.v[0]*e.v[0]+this.v[1]*e.v[1]},cross:function(e){return this.v[0]*e.v[1]-this.v[1]*e.v[0]},min:function(e){return new SglVec2(sglMin(this.v[0],e.v[0]),sglMin(this.v[1],e.v[1]))},max:function(e){return new SglVec2(sglMax(this.v[0],e.v[0]),sglMax(this.v[1],e.v[1]))}};SglVec3.prototype={clone:function(){return new SglVec3(this)},get copy(){return this.clone()},get x(){return this.v[0]},set x(e){this.v[0]=e},get y(){return this.v[1]},set y(e){this.v[1]=e},get z(){return this.v[2]},set z(e){this.v[2]=e},set:function(e,t,n){this.v[0]=e;this.v[1]=t;this.v[2]=n;return this},setVec:function(e){return this.set(e[0],e[1],e[2])},setScalar:function(e){return this.set(e,e,e)},setZero:function(){return this.setScalar(0)},setOne:function(){return this.setScalar(1)},at:function(e){return this.v[e]},get squaredLength(){return this.dot(this)},get length(){return sglSqrt(this.squaredLength)},normalize:function(){var e=this.length;if(e>0)e=1/e;this.v[0]*=e;this.v[1]*=e;this.v[2]*=e;return this},get normalized(){return this.clone().normalize()},get neg(){return new SglVec3(-this.v[0],-this.v[1],-this.v[2])},get abs(){return new SglVec3(sglAbs(this.v[0]),sglAbs(this.v[1]),sglAbs(this.v[2]))},get minComp(){var e=this.v[0];if(e>this.v[1])e=this.v[1];if(e>this.v[2])e=this.v[2];return e},get maxComp(){var e=this.v[0];if(e<this.v[1])e=this.v[1];if(e<this.v[2])e=this.v[2];return e},get argMin(){var e=0;if(this.v[e]>this.v[1])e=1;if(this.v[e]>this.v[2])e=2;return e},get argMax(){var e=0;if(this.v[e]>this.v[1])e=1;if(this.v[e]>this.v[2])e=2;return e},add:function(e){return new SglVec3(this.v[0]+e.v[0],this.v[1]+e.v[1],this.v[2]+e.v[2])},sub:function(e){return new SglVec3(this.v[0]-e.v[0],this.v[1]-e.v[1],this.v[2]-e.v[2])},mul:function(e){return new SglVec3(this.v[0]*e.v[0],this.v[1]*e.v[1],this.v[2]*e.v[2])},div:function(e){return new SglVec3(this.v[0]/e.v[0],this.v[1]/e.v[1],this.v[2]/e.v[2])},get rcp(){return new SglVec3(1/this.v[0],1/this.v[1],1/this.v[2])},dot:function(e){return this.v[0]*e.v[0]+this.v[1]*e.v[1]+this.v[2]*e.v[2]},cross:function(e){return new SglVec3(this.v[1]*e.v[2]-this.v[2]*e.v[1],this.v[2]*e.v[0]-this.v[0]*e.v[2],this.v[0]*e.v[1]-this.v[1]*e.v[0])},min:function(e){return new SglVec3(sglMin(this.v[0],e.v[0]),sglMin(this.v[1],e.v[1]),sglMin(this.v[2],e.v[2]))},max:function(e){return new SglVec3(sglMax(this.v[0],e.v[0]),sglMax(this.v[1],e.v[1]),sglMax(this.v[2],e.v[2]))}};SglVec4.prototype={clone:function(){return new SglVec4(this)},get copy(){return this.clone()},get x(){return this.v[0]},set x(e){this.v[0]=e},get y(){return this.v[1]},set y(e){this.v[1]=e},get z(){return this.v[2]},set z(e){this.v[2]=e},get w(){return this.v[3]},set w(e){this.v[3]=e},set:function(e,t,n,r){this.v[0]=e;this.v[1]=t;this.v[2]=n;this.v[3]=r;return this},setVec:function(e){return this.set(e[0],e[1],e[2],e[3])},setScalar:function(e){return this.set(e,e,e,e)},setZero:function(){return this.setScalar(0)},setOne:function(){return this.setScalar(1)},at:function(e){return this.v[e]},get squaredLength(){return this.dot(this)},get length(){return sglSqrt(this.squaredLength)},normalize:function(){var e=this.length;if(e>0)e=1/e;this.v[0]*=e;this.v[1]*=e;this.v[2]*=e;this.v[3]*=e;return this},get normalized(){return this.clone().normalize()},get neg(){return new SglVec4(-this.v[0],-this.v[1],-this.v[2],-this.v[3])},get abs(){return new SglVec4(sglAbs(this.v[0]),sglAbs(this.v[1]),sglAbs(this.v[2]),sglAbs(this.v[3]))},get minComp(){var e=this.v[0];if(e>this.v[1])e=this.v[1];if(e>this.v[2])e=this.v[2];if(e>this.v[3])e=this.v[3];return e},get maxComp(){var e=this.v[0];if(e<this.v[1])e=this.v[1];if(e<this.v[2])e=this.v[2];if(e<this.v[3])e=this.v[3];return e},get argMin(){var e=0;if(this.v[e]>this.v[1])e=1;if(this.v[e]>this.v[2])e=2;if(this.v[e]>this.v[3])e=2;return e},get argMax(){var e=0;if(this.v[e]>this.v[1])e=1;if(this.v[e]>this.v[2])e=2;if(this.v[e]>this.v[3])e=2;return e},add:function(e){return new SglVec4(this.v[0]+e.v[0],this.v[1]+e.v[1],this.v[2]+e.v[2],this.v[3]+e.v[3])},sub:function(e){return new SglVec4(this.v[0]-e.v[0],this.v[1]-e.v[1],this.v[2]-e.v[2],this.v[3]-e.v[3])},mul:function(e){return new SglVec4(this.v[0]*e.v[0],this.v[1]*e.v[1],this.v[2]*e.v[2],this.v[3]*e.v[3])},div:function(e){return new SglVec4(this.v[0]/e.v[0],this.v[1]/e.v[1],this.v[2]/e.v[2],this.v[3]/e.v[3])},get rcp(){return new SglVec4(1/this.v[0],1/this.v[1],1/this.v[2],1/this.v[3])},dot:function(e){return this.v[0]*e.v[0]+this.v[1]*e.v[1]+this.v[2]*e.v[2]+this.v[3]*e.v[3]},min:function(e){return new SglVec4(sglMin(this.v[0],e.v[0]),sglMin(this.v[1],e.v[1]),sglMin(this.v[2],e.v[2]),sglMin(this.v[3],e.v[3]))},max:function(e){return new SglVec4(sglMax(this.v[0],e.v[0]),sglMax(this.v[1],e.v[1]),sglMax(this.v[2],e.v[2]),sglMax(this.v[3],e.v[3]))}};SglPlane3.prototype={get normal(){return this._normal},set normal(e){this._normal=e.slice(0,3)},get offset(){return this._offset},set offset(e){this._offset=e.slize(0,3)},clone:function(){return new SglPlane3(this._normal,this._offset,false)},get copy(){return this.clone()},setup:function(e,t,n){this._normal[0]=e[0];this._normal[1]=e[1];this._normal[2]=e[2];this._offset=t;if(normalize){var r=sglSqrt(sglDotV3(this._normal));if(r>0){r=1/r;sglSelfMulV3S(this._normal,r);this._offset*=r}}}};SglBox3.prototype={get min(){return this._min},set min(e){this._min=e.slice(0,3)},get max(){return this._max},set max(e){this._max=e.slice(0,3)},clone:function(){return new SglBox3(this._min,this._max)},get copy(){return this.clone()},setup:function(e,t){for(var n=0;n<3;++n){this._min[n]=e[n];this._max[n]=t[n]}return this},get isNull(){return this._min[0]>this._max[0]},get isEmpty(){return this._min[0]==this._max[0]&&this._min[1]==this._max[1]&&this._min[2]==this._max[2]},get center(){return sglSelfMulV3S(sglAddV3(this._min,this._max),.5)},get size(){return sglSubV3(this._max,this._min)},get squaredDiagonal(){var e=this.size;return sglDotV3(e,e)},get diagonal(){return sglSqrt(this.squaredDiagonal)},get facesAreas(){var e=this.size;return[e[1]*e[2],e[0]*e[2],e[0]*e[1]]},get surfaceArea(){var e=this.facesArea;return(e[0]+e[1]+e[2])*2},get volume(){var e=this.size;return e[0]*e[1]*e[2]},offset:function(e){sglSelfSubV3S(this._min[i],e);sglSelfAddV3S(this._max[i],e);return this},corner:function(e){var t=this.size;return[this._min[0]+(e%2!=0?1:0)*t[0],this._min[1]+(e/2%2!=0?1:0)*t[1],this._min[2]+(e>3!=0?1:0)*t[2]]},transformed:function(e){var t=new SglBox3;var n=sglMulM4V3(e,this.corner(0),1);t.min=n;t.max=n;for(var r=1;r<8;++r){n=sglMulM4V3(e,this.corner(r),1);t.min=sglMinV3(t.min,n);t.max=sglMaxV3(t.max,n)}return t},addPoint:function(e){if(this.isNull){this.min=e;this.max=e}else{this.min=sglMinV3(this.min,e);this.max=sglMaxV3(this.min,e)}return this},addBox:function(e){if(!e.isNull){if(this.isNull){this.min=e.min;this.max=e.max}else{this.min=sglMinV3(this.min,e.min);this.max=sglMaxV3(this.max,e.max)}}return this}};SglSphere3.prototype={get center(){return this._center},set center(e){this._center=e.slice(0,3)},get radius(){return this._redius},set radius(e){this._radius=e},clone:function(){return new SglSphere3(this._center,this._radius)},get copy(){return this.clone()},setup:function(e,t){this._center[0]=e[0];this._center[1]=e[1];this._center[2]=e[2];this._radius=t;return this},get isNull(){return this._radius<0},get isEmpty(){return this._radius==0},get surfaceArea(){return 4*SGL_PI*this._radius*this._radius},get volume(){return 4/3*SGL_PI*this._radius*this._radius*this._radius}};SglMatrixStack.prototype={clone:function(){var e=new SglMatrixStack;e.s=[];for(var t=0;t<this._n+1;++t){e._s.push(sglDupM4(this._s[t]))}return e},get copy(){return this.clone()},reset:function(){this._s=[];this._s.push(sglIdentityM4());this._n=0;return this},get size(){return this._n+1},get top(){return sglDupM4(this._s[this._n])},get topRef(){return this._s[this._n]},push:function(){this._s.push(sglDupM4(this._s[this._n]));this._n++;return this},pop:function(){if(this._n>0){this._s.pop();this._n--}return this},load:function(e){this._s[this._n]=sglDupM4(e);return this},multiply:function(e){this._s[this._n]=sglMulM4(this._s[this._n],e);return this},loadIdentity:function(){this._s[this._n]=sglIdentityM4();return this},translate:function(e,t,n){return this.multiply(sglTranslationM4C(e,t,n))},rotate:function(e,t,n,r){return this.multiply(sglRotationAngleAxisM4C(e,t,n,r))},scale:function(e,t,n){return this.multiply(sglScalingM4C(e,t,n))},lookAt:function(e,t,n,r,i,s,o,u,a){return this.multiply(sglLookAtM4C(e,t,n,r,i,s,o,u,a))},ortho:function(e,t,n,r,i,s){return this.multiply(sglOrthoM4C(e,t,n,r,i,s))},frustum:function(e,t,n,r,i,s){return this.multiply(sglFrustumM4C(e,t,n,r,i,s))},perspective:function(e,t,n,r){return this.multiply(sglPerspectiveM4(e,t,n,r))}};SglTransformStack.prototype={clone:function(){var e=new SglTransformStack;e._ms=this._ms.clone();e._vs=this._vs.clone();e._ps=this._ps.clone();return e},get copy(){return this.clone()},reset:function(){this._ms.reset();this._vs.reset();this._ps.reset();return this},get model(){return this._ms},get view(){return this._vs},get projection(){return this._ps},get modelMatrix(){return this.model.top},get modelMatrixRef(){return this.model.topRef},get modelMatrixTranspose(){return sglTransposeM4(this.modelMatrixRef)},get modelMatrixInverse(){return sglInverseM4(this.modelMatrixRef)},get modelMatrixInverseTranspose(){return sglTransposeM4(this.modelMatrixInverse)},get viewMatrix(){return this.view.top},get viewMatrixRef(){return this.view.topRef},get viewMatrixTranspose(){return sglTransposeM4(this.viewMatrixRef)},get viewMatrixInverse(){return sglInverseM4(this.viewMatrixRef)},get viewMatrixInverseTranspose(){return sglTransposeM4(this.viewMatrixInverse)},get projectionMatrix(){return this.projection.top},get projectionMatrixRef(){return this.projection.topRef},get projectionMatrixTranspose(){return sglTransposeM4(this.projectionMatrixRef)},get projectionMatrixInverse(){return sglInverseM4(this.projectionMatrixRef)},get projectionMatrixInverseTranspose(){return sglTransposeM4(this.projectionMatrixInverse)},get modelViewMatrix(){return sglMulM4(this.viewMatrixRef,this.modelMatrixRef)},get modelViewMatrixTranspose(){return sglTransposeM4(this.modelViewMatrix)},get modelViewMatrixInverse(){return sglInverseM4(this.modelViewMatrix)},get modelViewMatrixInverseTranspose(){return sglTransposeM4(this.modelViewMatrixInverse)},get viewProjectionMatrix(){return sglMulM4(this.projectionMatrixRef,this.viewMatrixRef)},get viewProjectionMatrixTranspose(){return sglTransposeM4(this.viewProjectionMatrix)},get viewProjectionMatrixInverse(){return sglInverseM4(this.viewProjectionMatrix)},get viewProjectionMatrixInverseTranspose(){return sglTransposeM4(this.viewProjectionMatrixInverse)},get modelViewProjectionMatrix(){return sglMulM4(this.projectionMatrixRef,sglMulM4(this.viewMatrixRef,this.modelMatrixRef))},get modelViewProjectionMatrixTranspose(){return sglTransposeM4(this.modelViewProjectionMatrix)},get modelViewProjectionMatrixInverse(){return sglInverseM4(this.modelViewProjectionMatrix)},get modelViewProjectionMatrixInverseTranspose(){return sglTransposeM4(this.modelViewProjectionMatrixInverse)},get worldSpaceNormalMatrix(){return sglM4toM3(this.modelMatrixInverseTranspose)},get viewSpaceNormalMatrix(){return sglM4toM3(this.modelViewMatrixInverseTranspose)},get modelSpaceViewerPosition(){return sglV4toV3(sglGetColM4(this.modelViewMatrixInverse,3))},get modelSpaceViewDirection(){return sglNegV3(sglV4toV3(sglGetRowM4(this.modelViewMatrix,2)))},get worldSpaceViewerPosition(){return sglV4toV3(sglGetColM4(this.viewMatrixInverse,3))},get worldSpaceViewDirection(){return ssglNegV3(sglV4toV3(sglGetRowM4(this.viewMatrixRef,2)))}};_SglFrustumPlane.prototype={setup:function(e,t,n,r){var i=1/sglSqrt(e*e+t*t+n*n);this.normal[0]=e*i;this.normal[1]=t*i;this.normal[2]=n*i;this.offset=r*i;this.testVertex[0]=this.normal[0]>=0?1:0;this.testVertex[1]=this.normal[1]>=0?1:0;this.testVertex[2]=this.normal[2]>=0?1:0}};var SGL_OUTSIDE_FRUSTUM=0;var SGL_INTERSECT_FRUSTUM=1;var SGL_INSIDE_FRUSTUM=2;SglFrustum.prototype={setup:function(e,t,n){var r=[sglGetColM4(t,0),sglGetColM4(t,1),sglGetColM4(t,2)];var i=[sglLengthV4(r[0]),sglLengthV4(r[1]),sglLengthV4(r[2])];var s=sglRcpV3(i);var o=sglScalingM4V(i);var u=sglScalingM4V(s);r[0]=sglMulV4S(r[0],s[0]);r[1]=sglMulV4S(r[1],s[1]);r[2]=sglMulV4S(r[2],s[2]);var a=sglIdentityM4();sglSetRowM4V(a,0,r[0]);sglSetRowM4V(a,1,r[1]);sglSetRowM4V(a,2,r[2]);this._mvpMatrix=sglMulM4(e,t);this._billboardMatrix=sglMulM4(u,sglMulM4(a,o));this._viewport=n.slice(0,4);this._vp[0]=this._viewport[2]*.5;this._vp[1]=this._viewport[0]+this._viewport[2]*.5;this._vp[2]=this._viewport[3]*.5;this._vp[3]=this._viewport[1]+this._viewport[3]*.5;var f=this._mvpMatrix;var l=[f[3],f[7],f[11]];this._planes[0].setup(l[0]-f[0],l[1]-f[4],l[2]-f[8],f[15]-f[12]);this._planes[1].setup(l[0]+f[0],l[1]+f[4],l[2]+f[8],f[15]+f[12]);this._planes[2].setup(l[0]-f[1],l[1]-f[5],l[2]-f[9],f[15]-f[13]);this._planes[3].setup(l[0]+f[1],l[1]+f[5],l[2]+f[9],f[15]+f[13]);this._planes[4].setup(l[0]-f[2],l[1]-f[6],l[2]-f[10],f[15]-f[14]);this._planes[5].setup(l[0]+f[2],l[1]+f[6],l[2]+f[10],f[15]+f[14])},boxVisibility:function(e,t){var n=SGL_INSIDE_FRUSTUM;var r=[e,t];var i=null;for(var s=0;s<6;++s){i=this._planes[s];if(i.normal[0]*r[i.testVertex[0]][0]+i.normal[1]*r[i.testVertex[1]][1]+i.normal[2]*r[i.testVertex[2]][2]+i.offset<0){return SGL_OUTSIDE_FRUSTUM}if(i.normal[0]*r[1-i.testVertex[0]][0]+i.normal[1]*r[1-i.testVertex[1]][1]+i.normal[2]*r[1-i.testVertex[2]][2]+i.offset<0){n=SGL_INTERSECT_FRUSTUM}}return n},projectedSegmentSize:function(e,t){var n=t*.5;var r=sglV3toV4(e,0);var i=[-n,0,0,1];var s=[n,0,0,1];i=sglMulM4V4(this._billboardMatrix,i);i=sglAddV4(i,r);i=sglProjectV4(sglMulM4V4(this._mvpMatrix,i));s=sglMulM4V4(this._billboardMatrix,s);s=sglAddV4(s,r);s=sglProjectV4(sglMulM4V4(this._mvpMatrix,s));var o=this._vp[0]*sglAbs(s[0]-i[0]);return o}};SglVertexBuffer.prototype={get info(){return this._info},destroy:function(){if(this._info.valid){this.gl.deleteBuffer(this._info.handle)}this._info=null},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this._info.handle)},unbind:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}};SglIndexBuffer.prototype={get info(){return this._info},destroy:function(){if(this._info.valid){this.gl.deleteBuffer(this._info.handle)}this._info=null},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this._info.handle)},unbind:function(){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null)}};SglProgramAttribute.prototype={set index(e){this._prog.gl.bindAttribLocation(this._prog._info.handle,e,this._info.name);this._info.location=e},get index(){return this._info.location}};SglProgramUniform.prototype={set value(e){this._func(e)},get value(){return this._prog.gl.getUniform(this._prog._info.handle,this._info.location)}};SglProgramSampler.prototype={set unit(e){this._prog.gl.uniform1i(this._info.location,e);this._unit=e},get unit(){return this._unit}};SglProgram.prototype={get info(){return this._info},get attributes(){return this._attributes},get uniforms(){return this._uniforms},get samplers(){return this._samplers},destroy:function(){if(this._info.valid==null)return;var e=this.gl;e.deleteProgram(this._info.handle);for(var t in this._info.shaders){e.deleteShader(this._info.shaders[t].handle)}this._attributes=null;this._uniforms=null;this._samplers=null;this._info=null},get handle(){return this._info.handle},get isValid(){return this._info.valid},get log(){var e="";e+="-------------------------------------\n";for(var t in this._info.shaders){e+=this._info.shaders[t].log}e+=this._info.log;e+="-------------------------------------\n";e+="\n";return e},setDefaultBindings:function(){sglSetDefaultProgramBindings(this.gl,this._info)},synchronize:function(){sglProgramSynchronize(this.gl,this._info)},bind:function(){this.gl.useProgram(this._info.handle)},unbind:function(){},setAttributes:function(e){var t=null;for(var n in e){t=this._attributes[n];if(t){t.index=e[n]}}this.link()},setUniforms:function(e){var t=null;for(var n in e){t=this._uniforms[n];if(t){t.value=e[n]}}},setSamplers:function(e){var t=null;for(var n in e){t=this._samplers[n];if(t!=undefined){t.unit=e[n]}}}};SglTexture2D.prototype={get info(){return this._info},destroy:function(){if(this._info.handle==null)return;this.gl.deleteTexture(this._info.handle);this._info=null},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(e){this.gl.activeTexture(this.gl.TEXTURE0+e);this.gl.bindTexture(this._info.target,this._info.handle)},unbind:function(e){this.gl.activeTexture(this.gl.TEXTURE0+e);this.gl.bindTexture(this._info.target,null)},generateMipmap:function(){this.gl.generateMipmap(this._info.target)}};SglTextureCube.prototype={get info(){return this._info},destroy:function(){if(this._info.handle==null)return;this.gl.deleteTexture(this._info.handle);this._info=null},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(e){this.gl.activeTexture(this.gl.TEXTURE0+e);this.gl.bindTexture(this._info.target,this._info.handle)},unbind:function(e){this.gl.activeTexture(this.gl.TEXTURE0+e);this.gl.bindTexture(this._info.target,null)},generateMipmap:function(){this.gl.generateMipmap(this._info.target)}};SglRenderbuffer.prototype={get info(){return this._info},destroy:function(){if(this._info.handle==null)return;this.gl.deleteRenderbuffer(this._info.handle);this._info=null},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(){this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this._info.handle)},unbind:function(){this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null)}};SglFramebuffer.prototype={get info(){return this._info},get colorTargets(){return this._colorTargets},get depthTarget(){return this._depthTarget},get stencilTarget(){return this._stencilTarget},destroy:function(){if(this._info.handle==null)return;this.gl.deleteFramebuffer(this._info.handle);for(var e in this._colorTargets){var t=this._colorTargets[e];if(t){this._colorTargets[e].destroy()}}if(this._depthTarget){this._depthTarget.destroy()}if(this._stencilTarget){this._stencilTarget.destroy()}this._info=null;this.targets=null},get handle(){return this._info.handle},get isValid(){return this._info.valid},get width(){return this._info.width},get height(){return this._info.height},bind:function(e){var t=true;if(e!=undefined)t=e;if(t){this.gl.viewport(0,0,this._info.width,this._info.height)}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._info.handle)},unbind:function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},bindColor:function(e,t){this._colorTargets[e].bind(t)},unbindColor:function(e,t){this._colorTargets[e].unbind(t)},bindDepth:function(e){this._depthTarget.bind(e)},unbindDepth:function(e){this._depthTarget.unbind(e)},bindStencil:function(e){this._stencilTarget.bind(e)},unbindStencil:function(e){this._stencilTarget.unbind(e)},generateMipmap:function(e,t,n){var r=null;if(e){for(var i in this._colorTargets){r=this._colorTargets[i];if(!r)continue;if(r.info.target==this.gl.TEXTURE_2D){r.bind(0);r.generateMipmap();r.unbind(0)}}}if(t){r=this._depthTarget;if(r){if(r.info.target==this.gl.TEXTURE_2D){r.bind(0);r.generateMipmap();r.unbind(0)}}}if(n){r=this._stencilTarget;if(r){if(r.info.target==this.gl.TEXTURE_2D){r.bind(0);r.generateMipmap();r.unbind(0)}}}},attachColorTarget:function(e,t){if(!t)return false;if(e<0||e>=this._colorTargets.length)return false;if(t.width!=this.width||t.height!=this.height)return false;var n=this.gl;var r=this.gl.COLOR_ATTACHMENT0+e;if(t.target==n.TEXTURE_2D){n.framebufferTexture2D(n.FRAMEBUFFER,r,n.TEXTURE_2D,t.handle,0)}else if(t.target==n.RENDERBUFFER){n.framebufferRenderbuffer(n.FRAMEBUFFER,r,n.RENDERBUFFER,t.handle)}this._colorTargets[e]=t;return true},detachColorTarget:function(e){if(e<0||e>=this._colorTargets.length)return false;var t=this._colorTargets[e];if(!t)return false;var n=this.gl;if(t.target==n.TEXTURE_2D){n.framebufferTexture2D(n.FRAMEBUFFER,att,n.TEXTURE_2D,null,0)}else if(t.target==n.RENDERBUFFER){n.framebufferRenderbuffer(n.FRAMEBUFFER,att,n.RENDERBUFFER,null)}this._colorTargets[e]=null;return true}};SglAttributeStreamJS.prototype={get name(){return this._name},get size(){return this._size},get buffer(){return this._buff},get length(){return this._buff.length},get:function(e){return this._buff.slice(e*this._size,this._size)},set:function(e,t){var n=e*this._size;for(var i=0;i<this._size;++i){this._buff[n++]=t[i]}return r}};SglVertexStreamJS.prototype={get attributes(){return this._attribs},get length(){return this._length},addAttribute:function(e,t,n,r){var i=new SglAttributeStreamJS(e,t,n,r);this._attribs[e]=i;this._length=i.length},removeAttribute:function(e){if(!this._attribs[e])return;delete this._attribs[e];this._length=0;for(var t in this._attribs){this._length=this._attribs[t].length;break}}};var SGL_ARRAY_PRIMITIVE_STREAM=1;var SGL_INDEXED_PRIMITIVE_STREAM=2;var SGL_PACKED_INDEXED_PRIMITIVE_STREAM=3;var SGL_POINTS_LIST=1;var SGL_LINES_LIST=2;var SGL_LINE_STRIP=3;var SGL_LINE_LOOP=4;var SGL_TRIANGLES_LIST=5;var SGL_TRIANGLE_STRIP=6;var SGL_TRIANGLE_FAN=7;SglPrimitiveStreamJS.prototype={get type(){return undefined},get name(){return this._name},get mode(){return this._mode},get first(){return this._first},get length(){return this._length}};sglInherit(SglArrayPrimitiveStreamJS,SglPrimitiveStreamJS);sglInherit(SglIndexedPrimitiveStreamJS,SglPrimitiveStreamJS);SglConnectivityJS.prototype={get primitives(){return this._prims},addArrayPrimitives:function(e,t,n,r){var i=new SglArrayPrimitiveStreamJS(e,t,n,r);this._prims[e]=i},addIndexedPrimitives:function(e,t,n,r){var i=new SglIndexedPrimitiveStreamJS(e,t,n,r);this._prims[e]=i},removePrimitives:function(e){if(!this._prims[e])return;delete this._prims[e]}};SglMeshJS.prototype={get isValid(){return this._valid},set isValid(e){this._valid=e},get vertices(){return this._vert},get connectivity(){return this._conn},addVertexAttribute:function(e,t,n,r){this._vert.addAttribute(e,t,n,r)},removeVertexAttribute:function(e){this._vert.removeAttribute(e)},addArrayPrimitives:function(e,t,n,r){this._conn.addArrayPrimitives(e,t,n,r)},addIndexedPrimitives:function(e,t,n,r){this._conn.addIndexedPrimitives(e,t,n,r)},removePrimitives:function(e){this._conn.removePrimitives(e)}};SglMeshJS.prototype.parseOBJ=function(e){this.isValid=sglMeshJSImportOBJFromString(this,e);return this.isValid};SglMeshJS.prototype.importOBJ=function(e,t,n){return sglMeshJSImportOBJFromURL(this,e,t,n)};SglMeshJS.prototype.parseJSON=function(e){this.isValid=sglMeshJSImportJSONFromString(this,e);return this.isValid};SglMeshJS.prototype.importJSON=function(e,t,n){return sglMeshJSImportJSONFromURL(this,e,t,n)};SglAttributeStreamGL.prototype={get name(){return this._name},get size(){return this._size},get type(){return this._type},get isNormalized(){return this._norm},get stride(){return this._stride},get offset(){return this._offset},get buffer(){return this._buff},get length(){return this._length},destroy:function(){this._buff.destroy()},bind:function(e,t){var n=(t?t:0)*this._stride;this._buff.bind();this.gl.vertexAttribPointer(e,this._size,this._type,this._norm,this._stride,this._offset+n)},unbind:function(e){this._buff.unbind()}};SglVertexStreamGL.prototype={get attributes(){return this._attribs},get length(){return this._length},destroy:function(){for(var e in this._attribs){this._attribs[e].destroy()}},addAttribute:function(e,t,n,r){var i=new SglAttributeStreamGL(this.gl,e,t,n,r);this._attribs[e]=i;this._length=i.length},removeAttribute:function(e,t){if(!this._attribs[e])return;if(t){this._attribs[e].destroy()}delete this._attribs[e];this._length=0;for(var n in this._attribs){this._length=this._attribs[n].length;break}},bind:function(e,t){var n=null;for(var r in e){n=this._attribs[r];if(n){n.bind(e[r],t)}}},unbind:function(e){var t=null;for(var n in e){t=this._attribs[n];if(t){t.unbind(e[n])}}}};SglPrimitiveStreamGL.prototype={_clampRange:function(e,t){var n=this._first+this._length;var r=this._first+(e>=0?e:0);if(r>=n)return null;var i=t>=0?t:this._length;var s=r+i;if(s>n)i-=s-n;return[r,i]},_render:function(e,t){},get type(){return undefined},get name(){return this._name},get mode(){return this._mode},get first(){return this._first},get length(){return this._length},destroy:function(){if(this._destroy){this._destroy()}},bind:function(){},unbind:function(){},render:function(e,t){var n=this._clampRange(e,t);this._render(n[0],n[1])}};sglInherit(SglArrayPrimitiveStreamGL,SglPrimitiveStreamGL);SglArrayPrimitiveStreamGL.prototype._render=function(e,t){this.gl.drawArrays(this._mode,e,t)};sglInherit(SglIndexedPrimitiveStreamGL,SglPrimitiveStreamGL);SglIndexedPrimitiveStreamGL.prototype._destroy=function(){this._buff.destroy();this._buff=null};SglIndexedPrimitiveStreamGL.prototype.bind=function(){this._buff.bind()};SglIndexedPrimitiveStreamGL.prototype.unbind=function(){this._buff.unbind()};SglIndexedPrimitiveStreamGL.prototype._render=function(e,t){this.gl.drawElements(this._mode,t,this._idxType,e*this._stride)};sglInherit(SglPackedIndexedPrimitiveStreamGL,SglPrimitiveStreamGL);SglPackedIndexedPrimitiveStreamGL.prototype._destroy=function(){this._buff.destroy();this._buff=null};SglPackedIndexedPrimitiveStreamGL.prototype.bind=function(){this._buff.bind()};SglPackedIndexedPrimitiveStreamGL.prototype.unbind=function(){this._buff.unbind()};SglPackedIndexedPrimitiveStreamGL.prototype._clampBlockRange=function(e,t,n){var r=this._blockStartingIndices[e]+this._blockIndicesCount[e];var i=this._blockStartingIndices[e]+(t>=0?t:0);if(i>=r)return null;var s=n>=0?n:this._blockIndicesCount[e];var o=i+s;if(o>r)s-=o-r;return[i,s]};SglPackedIndexedPrimitiveStreamGL.prototype.blockRanges=function(e,t){var n=this._clampRange(e,t);var r=this._blockStartingIndices.length;var i=0;while(i<r&&n[0]<this._blockStartingIndices[i]){i++}if(i>=r)return null;var s=n[0]+n[1]-1;var o=i;while(o<r&&s>=this._blockStartingIndices[o]+this._blockIndicesCount[o]){o++}if(o>=r)o=r-1;var u=[];var a=n[0]-this._blockStartingIndices[i];var f=n[1];var l=a+n[1];if(l>this._blockIndicesCount[i])f=this._blockIndicesCount[i]-this._blockStartingIndices[i];u.push([i,a,f,this._blockStartingVertices[i]]);for(var c=i+1;c<o;++c){u.push([c,0,this._blockIndicesCount[c],this._blockStartingVertices[c]])}if(o>i){u.push([c,0,n[0]+n[1]-this._blockStartingIndices[o],this._blockStartingVertices[o]])}return u};SglPackedIndexedPrimitiveStreamGL.prototype.renderBlock=function(e,t,n){var r=this._clampBlockRange(e,t,n);this.gl.drawElements(this._mode,r[1],this._idxType,r[0]*this._stride)};SglConnectivityGL.prototype={get primitives(){return this._prims},destroy:function(){for(var e in this._prims){this._prims[e].destroy()}},addArrayPrimitives:function(e,t,n,r){var i=new SglArrayPrimitiveStreamGL(this.gl,e,t,n,r);this._prims[e]=i},addIndexedPrimitives:function(e,t,n){var r=new SglIndexedPrimitiveStreamGL(this.gl,e,t,n);this._prims[e]=r},addPackedIndexedPrimitives:function(e,t,n,r,i){var s=new SglPackedIndexedPrimitiveStreamGL(this.gl,e,t,n,r,i);this._prims[e]=s},removePrimitives:function(e,t){if(!this._prims[e])return;if(t){this._prims[e].destroy()}delete this._prims[e]}};SglMeshGL.prototype={get vertices(){return this._vert},get connectivity(){return this._conn},destroy:function(){this._vert.destroy();this._conn.destroy()},addVertexAttribute:function(e,t,n,r){this._vert.addAttribute(e,t,n,r)},removeVertexAttribute:function(e,t){this._vert.removeAttribute(e,t)},addArrayPrimitives:function(e,t,n,r){this._conn.addArrayPrimitives(e,t,n,r)},addIndexedPrimitives:function(e,t,n){this._conn.addIndexedPrimitives(e,t,n)},addPackedIndexedPrimitives:function(e,t,n,r,i){this._conn.addPackedIndexedPrimitives(e,t,n,r,i)},removePrimitives:function(e,t){this._conn.removePrimitives(e,t)}};var SGL_DefaultStreamMappingPrefix="a_";SglMeshGLRenderer.prototype={_bindVertexBuffers:function(e){this._mesh.vertices.bind(this._meshAttrMap,e)},_unbindVertexBuffers:function(){this._mesh.vertices.unbind(this._meshAttrMap)},get program(){return this.prog},synchronizeProgram:function(){this._prog.synchronize();var e=false;var t=0;var n=null;for(var r in this._prog.attributes){n=this._prog.attributes[r];if(n.index!=t){n.index=t;e=true}t++}if(e){this._prog.link()}var i=0;var s=null;for(var o in this._prog.samplers){s=this._prog.samplers[o];s.unit=i;i++}},getStreamMappingFromPrefix:function(e){var t=e.length;var n=new Object;var r=null;for(var i in this._prog.attributes){if(i.substr(0,t)==e){r=i.substr(t);if(r.length>0){n[i]=r}}}return n},setStreamMapping:function(e){this._updateEnabledVB=true;var t=null;this._mapping=this.getStreamMappingFromPrefix(SGL_DefaultStreamMappingPrefix);for(var n in e){t=e[r];if(this._prog.attributes[n]){this._mapping[n]=t}}this._meshAttrMap={};var r=null;for(var n in this._mapping){t=this._mapping[n];r=this._prog.attributes[n];this._meshAttrMap[t]=r.index}if(this._mesh){this._bindVertexBuffers(0)}},setStreamMappingFromPrefix:function(e){if(!e)e=SGL_DefaultStreamMappingPrefix;var t=this.getStreamMappingFromPrefix(e);this.setStreamMapping(t)},setUniforms:function(e){if(this._phase==0)return;this._prog.setUniforms(e)},setSamplers:function(e){if(this._phase==0)return;var t={};var n={};var r=null;for(var i in e){r=e[i];if(typeof r=="number"){t[i]=r}else{n[i]=r}}this._prog.setSamplers(t);var s=null;for(var i in n){s=this._prog.samplers[i];if(s){n[i].bind(s.unit)}}},begin:function(){if(this._phase!=0)return;this._prog.bind();this._phase=1},end:function(){if(this._phase!=1)return;this._prog.unbind();var e=this._prog.gl;for(var t in this._prog.attributes){e.disableVertexAttribArray(this._prog.attributes[t].index)}this._phase=0},beginMesh:function(e){if(this._phase!=1)return;this._updateEnabledVB=true;this._mesh=e;this._bindVertexBuffers(0);this._phase=2},endMesh:function(){if(this._phase!=2)return;this._unbindVertexBuffers();this._prog.gl.bindBuffer(this._prog.gl.ARRAY_BUFFER,null);this._mesh=null;this._phase=1},beginPrimitives:function(e){if(this._phase!=2)return;this._primStream=this._mesh.connectivity.primitives[e];this._primStream.bind();this._phase=3},endPrimitives:function(){if(this._phase!=3)return;this._primStream.unbind();this._primStream=null;this._phase=2},render:function(e,t){if(this._phase!=3)return;var n=this._prog.gl;var r=0;if(this._updateEnabledVB){this._updateEnabledVB=false;for(var i in this._mapping){r=this._prog.attributes[i].index;if(this._mesh.vertices.attributes[this._mapping[i]]){n.enableVertexAttribArray(r)}else{n.disableVertexAttribArray(r)}}}if(this._primStream.isPacked){if(this._primStream.blocksCount>0){var s=this._primStream.blockRanges(e,t);var o=s.length;for(var u=0;u<o;++u){this._bindVertexBuffers(s[u][3]);this._primStream.renderBlock(s[u][0],s[u][1],s[u][2])}}}else{this._primStream.render(e,t)}},renderMeshPrimitives:function(e,t,n,r){this.beginMesh(e);this.beginPrimitives(t);this.render(n,r);this.endPrimitives();this.endMesh()}};SglMeshJS.prototype.calculateBoundingBox=function(e){return sglMeshJSCalculateBBox(this,e)};SglMeshJS.prototype.toMeshGL=function(e){return sglMeshJStoGL(e,this)};SglMeshJS.prototype.toPackedMeshGL=function(e,t,n){return sglPackMeshJStoGL(e,this,t,n)};var SGL_TRACKBALL_NO_ACTION=0;var SGL_TRACKBALL_ROTATE=1;var SGL_TRACKBALL_PAN=2;var SGL_TRACKBALL_DOLLY=3;var SGL_TRACKBALL_SCALE=4;SglTrackball.prototype={_projectOnSphere:function(e,n){var r=1;var i=0;var s=sglSqrt(e*e+n*n);if(s<r*.7071067811865476){i=sglSqrt(r*r-s*s)}else{t=r/1.4142135623730951;i=t*t/s}return i},_transform:function(e,t,n,r){return sglMulM4V4(e,sglV4C(t,n,r,0))},_transformOnSphere:function(e,t,n){var r=this._projectOnSphere(t,n);return this._transform(e,t,n,r)},_translate:function(e,t){var n=sglInverseM4(this._matrix);var r=sglV3toV4(e,0);r=sglMulM4V4(n,r);r=sglMulSV4(t,r);var i=sglTranslationM4V(r);this._matrix=sglMulM4(this._matrix,i)},get action(){return this._action},set action(e){this._action=e},get matrix(){return this._matrix},reset:function(){this._matrix=sglIdentityM4();this._pts=[[0,0],[0,0]];this._action=SGL_TRACKBALL_NO_ACTION},track:function(e,t,n,r){this._pts[0][0]=this._pts[1][0];this._pts[0][1]=this._pts[1][1];this._pts[1][0]=t;this._pts[1][1]=n;switch(this._action){case SGL_TRACKBALL_ROTATE:this.rotate(e);break;case SGL_TRACKBALL_PAN:this.pan(e);break;case SGL_TRACKBALL_DOLLY:this.dolly(e,r);break;case SGL_TRACKBALL_SCALE:this.scale(e,r);break;default:break}},rotate:function(e){if(this._pts[0][0]==this._pts[1][0]&&this._pts[0][1]==this._pts[1][1])return;var t=sglInverseM4(e);var n=this._transformOnSphere(t,this._pts[0][0],this._pts[0][1]);var r=this._transformOnSphere(t,this._pts[1][0],this._pts[1][1]);var i=sglCrossV3(n,r);var s=sglLengthV3(i);var o=sglRotationAngleAxisM4V(s,i);this._matrix=sglMulM4(o,this._matrix)},pan:function(e){var t=sglInverseM4(e);var n=this._transform(t,this._pts[0][0],this._pts[0][1],-1);var r=this._transform(t,this._pts[1][0],this._pts[1][1],-1);var i=sglSubV3(r,n);this._translate(i,2)},dolly:function(e,t){var n=sglInverseM4(e);var r=this._transform(n,0,0,t);this._translate(r,1)},scale:function(e,t){var n=sglScalingM4C(t,t,t);this._matrix=sglMulM4(this._matrix,n)}};SglFirstPersonCamera.prototype={clone:function(){var e=new SglFirstPersonCamera;e._position=this._position.slice();e._angles=this._angles.slice();return e},get copy(){return this.clone()},lookAt:function(e,t,n,r,i,s,o){this._position=sglV3C(e,t,n);var u=sglSubV3([r,i,s],this._position);this._angles[0]=sglAtan2(u[1],-u[2]);this._angles[1]=sglAtan2(-u[0],-u[2]);this._angles[2]=o?o:0;return this},translate:function(e,t,n){var r=sglRotationAngleAxisM4C(this._angles[0],1,0,0);var i=sglRotationAngleAxisM4C(this._angles[1],0,1,0);var s=sglRotationAngleAxisM4C(this._angles[2],0,0,1);var o=sglMulM4(s,sglMulM4(i,r));var u=sglMulM4V4(o,[e,t,n,0]);this._position[0]+=u[0];this._position[1]+=u[1];this._position[2]+=u[2];return this},translateOnPlane:function(e,t,n){var r=sglRotationAngleAxisM4C(this._angles[1],0,1,0);var i=sglMulM4V4(r,[e,t,n,0]);this._position[0]+=i[0];this._position[1]+=i[1];this._position[2]+=i[2];return this},rotate:function(e,t,n){this._angles[0]+=e;this._angles[1]+=t;this._angles[2]+=n;return this},get matrix(){var e=sglRotationAngleAxisM4C(-this._angles[0],1,0,0);var t=sglRotationAngleAxisM4C(-this._angles[1],0,1,0);var n=sglRotationAngleAxisM4C(-this._angles[2],0,0,1);var r=sglTranslationM4V(sglNegV3(this._position));var i=sglMulM4(n,sglMulM4(e,sglMulM4(t,r)));return i}};SglCanvasUI.prototype={get canvas(){return this._canvas},get width(){return this._canvas.width},get height(){return this._canvas.height},get ignoreKeyRepeat(){return this._ignoreKeyRepeat},set ignoreKeyRepeat(e){this._ignoreKeyRepeat=e},get updateRate(){if(this._updRate<=0)return 0;return this._updRate},set updateRate(e){var t=e;if(t<0)t=0;if(t>1e3)t=1e3;if(this._updRate==t)return;this._updRate=t;if(this._timerID!=null){clearInterval(this._timerID);this._timerID=null}if(this._updRate>0){var n=1e3/this._updRate;if(n<1)n=1;var r=this._manager;this.timeNow=Date.now()/1e3;this.timePrev=this.timeNow;this.timeDelta=0;this._timerID=setInterval(function(){r.update()},n)}},get requestDraw(){var e=this;return function(){e._manager.requestDraw()}}};_SglCanvasManager.prototype={_getMouseClientPos:function(e){var t=this.canvas.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}},requestDraw:function(){if(this.rendering){if(!this._drawPending){this._drawPending=true;setTimeout(this._drawFunc,0)}}},blur:function(e){var t=false;for(var n in this.ui.mouseButtonsDown){if(this.ui.mouseButtonsDown[n]){this.ui.mouseButtonsDown[n]=false;if(this.handler.mouseUp){if(this.handler.mouseUp(this.gl,n,this.ui.mousePos.x,this.ui.mousePos.y)!=false){t=true}}}}for(var r in this.ui.keysDown){if(this.ui.keysDown[r]){this.ui.keysDown[r]=false;if(this.handler.keyUp){if(this.handler.keyUp(this.gl,0,r)!=false){t=true}}}}if(t){this.requestDraw()}},mouseOut:function(e){var t=false;for(var n in this.ui.mouseButtonsDown){if(this.ui.mouseButtonsDown[n]){this.ui.mouseButtonsDown[n]=false;if(this.handler.mouseOut){if(this.handler.mouseOut(this.gl,this.ui.mousePos.x,this.ui.mousePos.y)!=false){t=true}}}}if(t){this.requestDraw()}},mouseOver:function(e){},load:function(){this.ui.loadEvent=null;if(this.handler.load){if(this.handler.load(this.gl)!=false){}}this.requestDraw()},unload:function(){this.ui.unloadEvent=null;this.ui.updateRate=0;if(this.handler.unload){this.handler.unload(this.gl)}this.handler.ui=null;this.handler=null;this.ui=null},keyDown:function(e){this.ui.keyDownEvent=e;var t=String.fromCharCode(e.keyCode);this.ui.keysDown[t.toLowerCase()]=true;this.ui.keysDown[t.toUpperCase()]=true;if(!this.ui.keysDown[e.keyCode]||!this.ui.ignoreKeyRepeat){this.ui.keysDown[e.keyCode]=true;if(this.handler.keyDown){if(this.handler.keyDown(this.gl,e.keyCode,t)!=false){this.requestDraw()}}}},keyUp:function(e){this.ui.keyUpEvent=e;var t=String.fromCharCode(e.keyCode);this.ui.keysDown[t.toLowerCase()]=false;this.ui.keysDown[t.toUpperCase()]=false;this.ui.keysDown[e.keyCode]=false;if(this.handler.keyUp){if(this.handler.keyUp(this.gl,e.keyCode,t)!=false){this.requestDraw()}}},keyPress:function(e){this.ui.keyPressEvent=e;var t=String.fromCharCode(e.charCode);if(this.handler.keyPress){if(this.handler.keyPress(this.gl,e.charCode,t)!=false){this.requestDraw()}}if(e.preventDefault){e.preventDefault()}},mouseDown:function(e){this.ui.mouseDownEvent=e;var t=this._getMouseClientPos(e);var n=t.x;var r=this.canvas.height-1-t.y;this.ui.mousePrevPos.x=n;this.ui.mousePrevPos.y=r;this.ui.mousePos.x=n;this.ui.mousePos.y=r;this.ui.mouseDeltaPos.x=0;this.ui.mouseDeltaPos.y=0;this.ui.mouseButtonsDown[e.button]=true;if(this.handler.mouseDown){if(this.handler.mouseDown(this.gl,e.button,n,r)!=false){this.requestDraw()}}this.canvas.focus();if(e.preventDefault){e.preventDefault()}},mouseUp:function(e){this.ui.mouseUpEvent=e;var t=this._getMouseClientPos(e);var n=t.x;var r=this.canvas.height-1-t.y;this.ui.mousePrevPos.x=n;this.ui.mousePrevPos.y=r;this.ui.mousePos.x=n;this.ui.mousePos.y=r;this.ui.mouseDeltaPos.x=0;this.ui.mouseDeltaPos.y=0;this.ui.mouseButtonsDown[e.button]=false;if(this.handler.mouseUp){if(this.handler.mouseUp(this.gl,e.button,n,r)!=false){this.requestDraw()}}if(e.preventDefault){e.preventDefault()}},mouseMove:function(e){this.ui.mouseMoveEvent=e;var t=this._getMouseClientPos(e);var n=t.x;var r=this.canvas.height-1-t.y;this.ui.mousePrevPos.x=this.ui.mousePos.x;this.ui.mousePrevPos.y=this.ui.mousePos.y;this.ui.mousePos.x=n;this.ui.mousePos.y=r;this.ui.mouseDeltaPos.x=this.ui.mousePos.x-this.ui.mousePrevPos.x;this.ui.mouseDeltaPos.y=this.ui.mousePos.y-this.ui.mousePrevPos.y;if(this.handler.mouseMove){if(this.handler.mouseMove(this.gl,n,r)!=false){this.requestDraw()}}if(e.preventDefault){e.preventDefault()}},mouseWheel:function(e){this.ui.mouseWheelEvent=e;var t=this._getMouseClientPos(e);var n=t.x;var r=this.canvas.height-1-t.y;this.ui.mousePrevPos.x=n;this.ui.mousePrevPos.y=r;this.ui.mousePos.x=n;this.ui.mousePos.y=r;this.ui.mouseDeltaPos.x=0;this.ui.mouseDeltaPos.y=0;if(this.handler.mouseWheel){var i=0;if(!e){e=window.event}if(e.wheelDelta){i=e.wheelDelta/120;if(window.opera){i=-i}}else if(e.detail){i=-e.detail/3}if(i){if(this.handler.mouseWheel(this.gl,i,n,r)!=false){this.requestDraw()}}}if(e.preventDefault){e.preventDefault()}},click:function(e){this.ui.clickEvent=e;var t=this._getMouseClientPos(e);var n=t.x;var r=this.canvas.height-1-t.y;if(this.handler.click){if(this.handler.click(this.gl,e.button,n,r)!=false){this.requestDraw()}}},dblClick:function(e){this.ui.dblClickEvent=e;var t=this._getMouseClientPos(e);var n=t.x;var r=this.canvas.height-1-t.y;if(this.handler.dblClick){if(this.handler.dblClick(this.gl,e.button,n,r)!=false){this.requestDraw()}}if(e.preventDefault){e.preventDefault()}},resize:function(e){this.ui.resizeEvent=e;if(this.handler.resize){if(this.handler.resize(this.gl,this.canvas.width,this.canvas.height)!=false){this.requestDraw()}}if(e.preventDefault){e.preventDefault()}},update:function(){this.ui.updateEvent=null;var e=Date.now()/1e3;this.ui.timePrev=this.ui.timeNow;this.ui.timeNow=e;this.ui.timeDelta=this.ui.timeNow-this.ui.timePrev;var t=true;if(this.handler.update){t=this.handler.update(this.gl,this.ui.timeDelta)!=false}if(t){this.requestDraw()}},draw:function(){this.ui.drawEvent=null;if(this.handler.draw){this.handler.draw(this.gl)}this.gl.flush();this._drawPending=false}};var _SGL_RegisteredCanvas=new Object